<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¤¼æ¥å®¶åº­æ—¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --lilly-red: #E1251B;
            --lilly-pink: #FBCFC8;
            --lilly-black: #212121;
            --lilly-green-light: #e0f2f1;
            --lilly-green-dark: #00796b;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Helvetica', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            background-color: #f3f4f6;
        }
        #app-container {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative; 
            background-color: white;
        }
        #app-container::-webkit-scrollbar {
            display: none;  
        }
        .font-ringside {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s;
            min-height: 100%;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
            background-color: #f9fafb;
        }
        .page.full-height {
             height: 100%;
        }
        .page-content {
            flex-grow: 1;
            padding: 1.5rem;
        }
        .sticky-footer {
            position: sticky;
            bottom: 0;
            background-color: white;
            padding: 0.75rem 1.5rem 1.5rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            z-index: 10;
        }
        .lilly-button {
            background-color: var(--lilly-red);
            color: white;
        }
        .lilly-button:hover {
             opacity: 0.9;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .custom-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(4px);
        }
        .custom-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .custom-modal-content {
            background: white;
            border-radius: 1rem;
            width: 90%;
            max-width: 520px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            display: flex;
            padding: 0;
            overflow: hidden;
            flex-direction: column;
        }
         @media (min-width: 640px) {
            .custom-modal-content {
                flex-direction: row;
                max-width: 780px;
            }
        }
        .custom-modal-overlay.visible .custom-modal-content {
             transform: scale(1);
        }
        .modal-image-container {
             width: 100%;
             height: 150px;
             flex-shrink: 0;
        }
        @media (min-width: 640px) {
             .modal-image-container {
                width: 45%;
                height: auto;
             }
        }
        .modal-text-container {
            width: 100%;
            padding: 1.5rem;
            text-align: left;
            display: flex;
            flex-direction: column;
        }
         @media (min-width: 640px) {
            .modal-text-container {
                width: 55%;
                padding: 2rem;
            }
         }
        .custom-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 1rem;
        }
        .custom-modal-text {
            color: #555;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            flex-grow: 1;
        }
        @keyframes pulse-scale {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.7));
            }
            50% {
                transform: scale(1.1);
                filter: drop-shadow(0 0 10px rgba(255, 255, 255, 1));
            }
        }
        .map-hotspot {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            animation: pulse-scale 2.5s infinite ease-in-out;
            transition: transform 0.2s;
        }
        .map-hotspot:hover {
            transform: scale(1.15);
        }
        .map-icon {
            width: 44px;
            height: 44px;
            background-color: rgba(251, 191, 36, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .map-label {
            margin-top: 5px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
        }
        .map-nav {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
        }
        .map-nav-btn {
            background-color: rgba(255,255,255,0.9);
            color: #1f2937;
            border-radius: 16px;
            padding: 0.75rem 0;
            width: 120px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }
        .map-nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .scratch-container {
            position: relative;
            width: 100%;
            cursor: crosshair;
            border-radius: 0.75rem;
            overflow: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .scratch-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
        
        #explore-fab {
            position: absolute;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 40;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            animation: pulse-scale 2.0s infinite ease-in-out;
            filter: drop-shadow(0 0 10px rgba(245, 158, 11, 1));
        }
        
        /* Craft & Badminton Card Styles */
        .event-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }
        .event-card-header {
            padding: 1rem 1rem 0.5rem;
        }
        .event-card-body {
            padding: 0 1rem 1rem;
        }
        .session-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 0.5rem;
        }
        /* New Scratch Reveal Styles */
        .themed-activity-card {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            border-radius: 0.75rem;
            padding: 0.75rem;
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 220px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .themed-activity-card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .themed-activity-card img {
             width: 48px;
             height: 48px;
             border-radius: 0.5rem;
             object-fit: cover;
             flex-shrink: 0;
        }
        .themed-activity-card h4 {
            font-weight: 700;
            font-size: 0.9rem;
            color: #1f2937;
        }
        .themed-activity-card p {
             font-size: 0.75rem;
             color: #4b5563;
        }

    </style>
</head>
<body>

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="app-container">
    </div>
    
    <!-- å…¨å±€é€šç”¨æ¨¡æ€æ¡† -->
    <div id="customModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <div class="modal-image-container">
                <img data-id="modalImage" src="" class="w-full h-full object-cover">
            </div>
            <div class="modal-text-container">
                <h3 data-id="modalTitle" class="custom-modal-title font-ringside">æç¤º</h3>
                <p data-id="modalText" class="custom-modal-text">è¿™æ˜¯ä¸€ä¸ªæç¤ºä¿¡æ¯ã€‚</p>
                <button data-id="modalCloseBtn" class="w-full lilly-button font-bold py-3 px-4 rounded-lg mt-auto">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ¢ç´¢ä¹‹æ—…æ¨¡æ€æ¡† -->
    <div id="exploreModal" class="custom-modal-overlay">
         <div class="custom-modal-content !p-6 !max-w-md !flex-col">
            <h3 class="custom-modal-title font-ringside">å¼€å¯ä½ çš„å¥‡é‡ä¹‹æ—…ï¼</h3>
            <p class="custom-modal-text">ä¸‰å¤§ä¸»é¢˜ä¸–ç•Œï¼Œä¹è¶£å„ä¸ç›¸åŒã€‚é€‰æ‹©ä¸€ä¸ªï¼Œäº²æ‰‹æ­å¼€å®ƒçš„ç¥ç§˜é¢çº±å§ï¼</p>
            <div class="space-y-3 mt-4 w-full">
                <div data-action="showScratchPage" data-type="fun" class="p-4 bg-gradient-to-br from-yellow-200 to-amber-300 rounded-xl cursor-pointer text-left hover:shadow-lg transition-shadow">
                    <h4 class="font-bold text-lg text-amber-800 font-ringside">ã€Œè¶£ã€Â· å¥‡æƒ³ä¸–ç•Œ</h4>
                    <p class="text-sm text-amber-700 mt-1">äº²è¿‘è‡ªç„¶ï¼Œæ”¾é£ç«¥å¿ƒï¼</p>
                </div>
                <div data-action="showScratchPage" data-type="win" class="p-4 bg-gradient-to-br from-red-200 to-rose-300 rounded-xl cursor-pointer text-left hover:shadow-lg transition-shadow">
                    <h4 class="font-bold text-lg text-rose-800 font-ringside">ã€Œèµ¢ã€Â· å¡è·¯é‡Œæˆ˜åœº</h4>
                    <p class="text-sm text-rose-700 mt-1">å›¢é˜Ÿé›†ç»“ï¼Œä¸ºè£èª‰è€Œæˆ˜ï¼</p>
                </div>
                <div data-action="showScratchPage" data-type="diy" class="p-4 bg-gradient-to-br from-purple-200 to-violet-300 rounded-xl cursor-pointer text-left hover:shadow-lg transition-shadow">
                    <h4 class="font-bold text-lg text-violet-800 font-ringside">ã€Œä½œã€Â· æ…¢æ—¶å…‰å·¥åŠ</h4>
                    <p class="text-sm text-violet-700 mt-1">é™ä¸‹å¿ƒï¼Œä¸å®¶äººå…±åˆ›æ¸©é¦¨ã€‚</p>
                </div>
            </div>
            <button data-action="closeExploreModal" class="w-full mt-6 bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg">è¿”å›åœ°å›¾</button>
        </div>
    </div>

<!-- é¡µé¢æ¨¡æ¿ -->
<template id="app-template">
    <!-- å¼€å±é¡µ -->
    <div id="splashPage" class="page flex flex-col justify-end items-center text-center p-8 bg-cover bg-center" style="background-image: url('https://raw.githubusercontent.com/gaoshijun1983-collab/Lilly-H5/main/1.1%20%E5%BC%80%E5%B1%8F%E9%A1%B5%E4%B8%BB%E8%A7%86%E8%A7%89%EF%BC%881179%C3%972556%EF%BC%89.png'); height: 100%;">
        <button data-action="showPage" data-page="verificationPage" class="w-full max-w-xs bg-white text-red-600 font-bold py-4 px-4 rounded-full shadow-2xl transition-transform transform hover:scale-105 animate-pulse mb-12 font-ringside">
             å¼€å¯å®¶åº­æ—¥ä¹‹æ—…
        </button>
    </div>

    <!-- å‘˜å·¥éªŒè¯é¡µ -->
    <div id="verificationPage" class="page flex items-center justify-center p-6 bg-gray-50">
        <div class="bg-white rounded-2xl p-8 shadow-xl text-center w-full max-w-sm">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 font-ringside" style="color: var(--lilly-red);">å‘˜å·¥èº«ä»½éªŒè¯</h2>
            <p class="text-gray-600 mb-6">è¯·è¾“å…¥æ‚¨çš„ä¿¡æ¯ä»¥ç»§ç»­</p>
            <div class="space-y-4">
                <input data-id="employeeIdInput" type="text" placeholder="å‘˜å·¥å·" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition" value="Lilly001">
                <input data-id="employeeNameInput" type="text" placeholder="å§“å" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition" value="å¼ ä¼Ÿ">
                <input data-id="employeePhoneInput" type="tel" placeholder="ç”µè¯" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition" value="13800138000">
            </div>
            <p data-id="verificationError" class="text-red-500 text-sm mt-2 h-5"></p>
            <button data-action="verifyEmployee" class="w-full lilly-button font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-transform transform hover:scale-105 mt-4">
                éªŒè¯è¿›å…¥
            </button>
        </div>
    </div>
    
    <!-- åœ°å›¾é¡µ -->
    <div id="mapPage" class="page full-height flex-col bg-gray-100">
        <div class="relative w-full aspect-[4/3] sm:aspect-[2/1] bg-cover bg-center" style="background-image: url('https://raw.githubusercontent.com/gaoshijun1983-collab/H5-update/main/Untitled-20250903-133831-2264-4x.jpg');">
             <div class="absolute top-4 left-4 p-3 bg-gradient-to-r from-white/90 to-white/70 backdrop-blur-sm rounded-xl shadow-lg text-gray-700 max-w-xs sm:max-w-sm flex items-center gap-3">
                 <div class="flex-shrink-0 bg-red-100 p-2 rounded-full">
                    <svg class="w-6 h-6 text-lilly-red" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                 </div>
                 <div>
                    <h2 class="font-bold font-ringside text-sm text-lilly-red">ä»åˆååˆ°æ˜Ÿè¾°ï¼Œå¿«ä¹ä¸è½å¹•</h2>
                    <p class="text-xs mt-1">ä»Šå¹´ç‹‚æ¬¢å»¶é•¿è‡³å¤œæ™šï¼ä½“éªŒç™½æ—¥æ´»åŠ›ï¼Œäº«å—æ˜Ÿç©ºä¸‹çš„æ´¾å¯¹ä¸çƒŸèŠ±ï¼</p>
                 </div>
            </div>
            
            <div data-action="showPage" data-page="badmintonIntroPage" class="map-hotspot" style="top: 70%; left: 25%; animation-delay: 0.2s; transform: scale(1.1);">
                <div class="map-icon" style="width: 50px; height: 50px; font-size: 28px; background-color: #ef4444;">ğŸ¸</div>
                <div class="map-label" style="font-size: 14px; padding: 4px 12px;">ã€Œè°ç¾½äº‰é”‹ã€å¤§èµ›</div>
            </div>
            <div data-action="showHighlight" data-highlight="event" class="map-hotspot" style="top: 65%; left: 50%; transform: translateX(-50%);">
                <div class="map-icon">ğŸ’¥</div>
                <div class="map-label">å°–å«æå‡»èµ›</div>
            </div>
             <div data-action="showPage" data-page="craftsBookingPage" class="map-hotspot" style="top: 30%; left: 20%; animation-delay: 0.4s; transform: scale(1.1);">
                <div class="map-icon" style="width: 50px; height: 50px; font-size: 28px; background-color: #a855f7;">ğŸ¨</div>
                <div class="map-label" style="font-size: 14px; padding: 4px 12px;">æ…¢æ—¶å…‰å·¥åŠ</div>
            </div>
            <div data-action="showHighlight" data-highlight="offroad" class="map-hotspot" style="top: 35%; left: 80%; animation-delay: 0.3s;">
                <div class="map-icon">ğŸš™</div>
                <div class="map-label">è¶Šé‡è½¦</div>
            </div>
             <div data-action="showHighlight" data-highlight="picking" class="map-hotspot" style="top: 55%; left: 78%;">
                <div class="map-icon">ğŸ§º</div>
                <div class="map-label">é‡é¤åŒº</div>
            </div>
            <div data-action="showHighlight" data-highlight="party" class="map-hotspot" style="top: 80%; left: 80%; animation-delay: 0.5s;">
                <div class="map-icon">ğŸ”¥</div>
                <div class="map-label">ç¯ç«æ´¾å¯¹</div>
            </div>
            <div data-action="showHighlight" data-highlight="fireworks" class="map-hotspot" style="top: 70%; left: 88%;">
                 <div class="map-icon">ğŸ†</div>
                 <div class="map-label">çƒŸèŠ±ç§€</div>
            </div>
            <div id="explore-fab" data-action="openExploreModal">
                <div class="map-icon !flex-col" style="width: 60px; height: 60px; font-size: 18px; background-color: #f59e0b;">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div class="map-label" style="font-size: 14px; padding: 4px 10px;">å¼€å¯ä¸‰å¤§å¥‡é‡</div>
            </div>
        </div>

        <nav class="map-nav">
            <button data-action="showPage" data-page="registrationPage" class="map-nav-btn">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                <span>æŠ¥åå…¥å£</span>
            </button>
            <button data-action="showPhotoAlbum" class="map-nav-btn">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <span>ç²¾å½©ç¬é—´</span>
            </button>
            <button data-action="showMyBookings" class="map-nav-btn">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path></svg>
                <span>æˆ‘çš„å‡­è¯</span>
            </button>
        </nav>
    </div>

    <!-- åˆ®åˆ®å¡é¡µ -->
    <div id="scratchPage" class="page">
        <div class="page-content">
            <h2 data-id="scratchTitle" class="text-3xl font-bold mb-2 font-ringside"></h2>
            <p class="text-gray-600 mb-4">æ“¦äº®è¿™ç‰‡åŒºåŸŸï¼Œçœ‹çœ‹è—ç€å“ªäº›å¥‡å¦™ä¹è¶£ï¼</p>
            
            <div data-id="scratchContainer" class="scratch-container">
                <canvas data-id="scratchCanvas" class="scratch-canvas"></canvas>
                <div data-id="scratchContent" class="rounded-lg">
                    <div data-id="activityListContainer" class="space-y-4">
                    </div>
                </div>
            </div>
        </div>
         <div class="sticky-footer">
            <button data-action="closeScratchPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">è¿”å›æ¢ç´¢ä¹‹æ—…</button>
        </div>
    </div>
    
    <!-- å®¶åº­æ—¥æŠ¥åé¡µ -->
    <div id="registrationPage" class="page">
         <div class="page-content">
            <h2 class="text-3xl font-bold mb-6 font-ringside" style="color: var(--lilly-red);">æ´»åŠ¨æŠ¥å</h2>
            <div class="space-y-6">
                <div>
                    <label class="font-semibold text-gray-700">å‘˜å·¥ä¿¡æ¯ (æ‚¨æœ¬äºº)</label>
                    <div class="mt-2 p-4 bg-gray-100 rounded-lg">
                        <p><strong>å·¥å·:</strong> <span data-id="regEmployeeId"></span></p>
                        <p><strong>å§“å:</strong> <span data-id="regEmployeeName"></span></p>
                        <p><strong>ç”µè¯:</strong> <span data-id="regEmployeePhone"></span></p>
                    </div>
                </div>
                <div>
                    <label class="font-semibold text-gray-700">å®¶å±ä¿¡æ¯ (å¦‚æ— å®¶å±åŒè¡Œï¼Œæ­¤é¡¹å¯ä¸å¡«)</label>
                    <div class="mt-2 p-4 border rounded-lg space-y-4">
                        <div data-id="familyFormsContainer" class="space-y-3"></div>
                        <button data-action="addFamilyMemberForm" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition text-sm">
                            + æ·»åŠ å®¶å±
                        </button>
                    </div>
                </div>
                <div>
                    <label class="font-semibold text-gray-700">ç”¨é¤å®‰æ’ (ä¸‰æ‰¹æ¬¡åˆ†æµ)</label>
                    <div class="space-y-2 mt-2">
                        <label class="flex items-center p-4 border rounded-lg has-[:checked]:bg-red-50 has-[:checked]:border-red-400 cursor-pointer">
                            <input type="radio" name="dining" value="17:00 - 17:40 (çº¢ç¥¨)" class="h-5 w-5" style="accent-color: var(--lilly-red);">
                            <span class="ml-3"><strong>æ‰¹æ¬¡ä¸€ (çº¢ç¥¨):</strong> 17:00 - 17:40</span>
                        </label>
                        <label class="flex items-center p-4 border rounded-lg has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                            <input type="radio" name="dining" value="17:40 - 18:20 (è“ç¥¨)" class="h-5 w-5" checked>
                            <span class="ml-3"><strong>æ‰¹æ¬¡äºŒ (è“ç¥¨):</strong> 17:40 - 18:20</span>
                        </label>
                        <label class="flex items-center p-4 border rounded-lg has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-400 cursor-pointer">
                            <input type="radio" name="dining" value="18:20 - 19:00 (é»„ç¥¨)" class="h-5 w-5">
                            <span class="ml-3"><strong>æ‰¹æ¬¡ä¸‰ (é»„ç¥¨):</strong> 18:20 - 19:00</span>
                        </label>
                    </div>
                </div>
                 <div>
                    <label class="font-semibold text-gray-700">å‡ºè¡Œæ–¹å¼</label>
                    <div class="flex gap-4 mt-2">
                         <label class="flex-1 flex items-center p-4 border rounded-lg has-[:checked]:bg-green-50 has-[:checked]:border-green-400 cursor-pointer">
                            <input type="radio" name="transport" value="å…¬å¸å¤§å·´" class="h-5 w-5 text-green-600">
                            <span class="ml-3">å…¬å¸å¤§å·´</span>
                        </label>
                         <label class="flex-1 flex items-center p-4 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-400 cursor-pointer">
                            <input type="radio" name="transport" value="è‡ªè¡Œå‰å¾€" class="h-5 w-5 text-indigo-600" checked>
                            <span class="ml-3">è‡ªè¡Œå‰å¾€</span>
                        </label>
                    </div>
                    <div data-id="transportDetails" class="mt-4 hidden p-4 bg-green-50 border border-green-200 rounded-lg">
                        <p class="font-semibold text-green-800">ç­è½¦ä¿¡æ¯</p>
                        <p class="text-sm text-green-700 mt-1">å…·ä½“ç­è½¦è·¯çº¿å’Œæ—¶é—´å®‰æ’ï¼Œå°†ç”±HRåœ¨æ´»åŠ¨å‰ç»Ÿä¸€é€šçŸ¥ï¼Œè¯·ç•™æ„åç»­é‚®ä»¶ã€‚
                    </div>
                </div>
                <button data-action="submitRegistration" class="w-full mt-8 lilly-button font-bold py-4 px-4 rounded-lg hover:opacity-90 transition-transform transform hover:scale-105">
                    ç¡®è®¤ä¿¡æ¯ï¼Œç”Ÿæˆæˆ‘çš„å‡ºå‘åˆ¸
                </button>
            </div>
        </div>
         <div class="sticky-footer">
            <button data-action="showPage" data-page="mapPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">
                è¿”å›åœ°å›¾é¦–é¡µ
            </button>
        </div>
    </div>
    
    <!-- æŠ¥åæˆåŠŸ/æˆ‘çš„å‡­è¯é¡µ -->
    <div id="successPage" class="page">
        <div class="page-content flex flex-col items-center justify-center text-center">
            <div class="w-24 h-24 rounded-full flex items-center justify-center mb-6 mx-auto" style="background-color: var(--lilly-green-light);">
                <svg class="w-16 h-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h2 class="text-3xl font-bold font-ringside" style="color: var(--lilly-red);">æŠ¥åæˆåŠŸ!</h2>
            <p class="text-gray-600 mt-2 mb-8">è¯·å‡­æ­¤ç”µå­åˆ¸åœ¨ç°åœºç­¾åˆ°ã€‚</p>
            <div class="bg-white p-4 rounded-lg shadow-md w-full max-w-xs">
                 <img data-id="qrCode" src="https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=LillyFamilyDay-Default" alt="æ¨¡æ‹Ÿç­¾åˆ°äºŒç»´ç " class="w-full rounded-md">
                 <p class="mt-4 font-semibold text-lg" data-id="successName"></p>
                 <p class="text-sm text-gray-500" data-id="successId"></p>
            </div>
            <div data-id="allMyBookings" class="mt-6 text-left w-full max-w-xs bg-gray-50 p-4 rounded-lg">
            </div>
        </div>
         <div class="sticky-footer">
              <button data-action="showPage" data-page="mapPage" class="w-full p-4 lilly-button rounded-xl text-center hover:opacity-90 transition font-semibold">
                è¿”å›åœ°å›¾é¦–é¡µ
            </button>
        </div>
    </div>

    <!-- æ´»åŠ¨è¯¦æƒ…é¡µ -->
    <div id="itemDetailPage" class="page">
        <div class="page-content">
            <img data-id="itemDetailImage" src="" class="w-full h-48 object-cover rounded-lg mb-4 shadow-md">
            <h2 data-id="itemDetailTitle" class="text-3xl font-bold mb-4 font-ringside"></h2>
            <p data-id="itemDetailDescription" class="text-gray-600 leading-relaxed"></p>
            <div class="mt-6 bg-gray-100 p-4 rounded-lg">
                <h3 class="font-bold text-lg text-gray-800 mb-2">è§„åˆ™è¶£è§£</h3>
                <p data-id="itemDetailRules" class="text-gray-600 text-sm"></p>
            </div>
        </div>
        <div class="sticky-footer">
            <button data-id="itemDetailBackButton" data-action="returnToScratchPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">è¿”å›åˆ—è¡¨</button>
        </div>
    </div>
    
    <!-- ç¾½æ¯›çƒå¤§èµ›ä»‹ç»é¡µ -->
    <div id="badmintonIntroPage" class="page">
        <div class="page-content !p-0 sm:!p-6">
             <div class="relative">
                <img src="https://images.unsplash.com/photo-1518291361833-53e33c7f1a3a?q=80&w=2574&auto=format&fit=crop" class="w-full h-40 sm:h-56 object-cover sm:rounded-2xl">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent sm:rounded-2xl"></div>
                <div class="absolute bottom-0 left-0 p-4 sm:p-6">
                    <h2 class="text-3xl font-bold font-ringside text-white">ã€Œè°ç¾½äº‰é”‹ã€å¤§èµ›</h2>
                    <p class="text-white/90 mt-1 text-sm">çƒ­è¡€é›†ç»“ï¼ŒæŒ¥æ‹ç‚¹ç‡ƒèµ›åœºï¼</p>
                </div>
            </div>
            <div class="p-4 sm:p-0 mt-4 space-y-4">
                <div data-action="showBadmintonRegPage" data-page="badmintonRegisterPage_mens" class="event-card flex items-center justify-between p-4 cursor-pointer hover:shadow-xl transition-shadow bg-gradient-to-r from-blue-50 to-white">
                    <div>
                        <h4 class="font-bold text-blue-800 font-ringside text-lg">ç”·å­å•æ‰“</h4>
                        <p class="text-sm text-blue-700 mt-1">è‹±é›„é›†ç»“ï¼Œä¸€æˆ˜å°ç‹</p>
                    </div>
                    <div class="text-right text-sm flex-shrink-0 ml-4">
                        <p class="font-semibold text-blue-800">å·²æŠ¥å: <span data-id="mens_count">0</span></p>
                        <p class="text-xs text-blue-600 mt-1">å‰©ä½™: <span data-id="mens_remain">16</span></p>
                    </div>
                </div>
                <div data-action="showBadmintonRegPage" data-page="badmintonRegisterPage_womens" class="event-card flex items-center justify-between p-4 cursor-pointer hover:shadow-xl transition-shadow bg-gradient-to-r from-pink-50 to-white">
                    <div>
                        <h4 class="font-bold text-pink-800 font-ringside text-lg">å¥³å­å•æ‰“</h4>
                        <p class="text-sm text-pink-700 mt-1">é“¿é”µç«ç‘°ï¼Œèµ›åœºç»½æ”¾</p>
                    </div>
                    <div class="text-right text-sm flex-shrink-0 ml-4">
                        <p class="font-semibold text-pink-800">å·²æŠ¥å: <span data-id="womens_count">0</span></p>
                        <p class="text-xs text-pink-600 mt-1">å‰©ä½™: <span data-id="womens_remain">16</span></p>
                    </div>
                </div>
                <div data-action="showBadmintonRegPage" data-page="badmintonRegisterPage_mixed" class="event-card flex items-center justify-between p-4 cursor-pointer hover:shadow-xl transition-shadow bg-gradient-to-r from-purple-50 to-white">
                     <div>
                        <h4 class="font-bold text-purple-800 font-ringside text-lg">æ··åˆåŒæ‰“</h4>
                        <p class="text-sm text-purple-700 mt-1">æœ€ä½³æ‹æ¡£ï¼Œé»˜å¥‘è‡´èƒœ</p>
                    </div>
                    <div class="text-right text-sm flex-shrink-0 ml-4">
                        <p class="font-semibold text-purple-800">å·²æŠ¥å: <span data-id="mixed_count">0</span></p>
                        <p class="text-xs text-purple-600 mt-1">å‰©ä½™: <span data-id="mixed_remain">16</span></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="sticky-footer">
            <button data-action="showPage" data-page="mapPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">è¿”å›åœ°å›¾é¦–é¡µ</button>
        </div>
    </div>

    <!-- ç¾½æ¯›çƒæŠ¥åé¡µ -->
    <div id="badmintonRegisterPage_mens" class="page badminton-reg-page">
        <div class="page-content"><h2 class="text-3xl font-bold mb-6 font-ringside" style="color: var(--lilly-red);">ç”·å­å•æ‰“æŠ¥å</h2><form class="space-y-4" data-type="mens"><p class="text-sm text-gray-600">è¯·å¡«å†™æ‚¨çš„å‚èµ›ä¿¡æ¯ã€‚</p><input type="text" placeholder="å§“å" name="name1" class="w-full px-4 py-3 border-2 rounded-lg" required><input type="tel" placeholder="ç”µè¯" name="phone1" class="w-full px-4 py-3 border-2 rounded-lg" required><button type="submit" class="w-full mt-4 lilly-button font-bold py-3 rounded-lg hover:opacity-90">ç¡®è®¤æŠ¥å</button></form></div>
        <div class="sticky-footer"><button data-action="showPage" data-page="badmintonIntroPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">è¿”å›å¤§èµ›ä»‹ç»</button></div>
    </div>
    <div id="badmintonRegisterPage_womens" class="page badminton-reg-page">
        <div class="page-content"><h2 class="text-3xl font-bold mb-6 font-ringside" style="color: var(--lilly-red);">å¥³å­å•æ‰“æŠ¥å</h2><form class="space-y-4" data-type="womens"><p class="text-sm text-gray-600">è¯·å¡«å†™æ‚¨çš„å‚èµ›ä¿¡æ¯ã€‚</p><input type="text" placeholder="å§“å" name="name1" class="w-full px-4 py-3 border-2 rounded-lg" required><input type="tel" placeholder="ç”µè¯" name="phone1" class="w-full px-4 py-3 border-2 rounded-lg" required><button type="submit" class="w-full mt-4 lilly-button font-bold py-3 rounded-lg hover:opacity-90" style="background-color: #ec4899;">ç¡®è®¤æŠ¥å</button></form></div>
        <div class="sticky-footer"><button data-action="showPage" data-page="badmintonIntroPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">è¿”å›å¤§èµ›ä»‹ç»</button></div>
    </div>
    <div id="badmintonRegisterPage_mixed" class="page badminton-reg-page">
        <div class="page-content"><h2 class="text-3xl font-bold mb-6 font-ringside" style="color: var(--lilly-red);">æ··åˆåŒæ‰“æŠ¥å</h2><form class="space-y-6" data-type="mixed"><div><label class="font-semibold text-gray-700">é˜Ÿå‘˜ä¸€ä¿¡æ¯</label><div class="space-y-3 mt-2 p-4 border rounded-lg"><input type="text" placeholder="å§“å" name="name1" class="w-full px-4 py-3 border-2 rounded-lg" required><input type="tel" placeholder="ç”µè¯" name="phone1" class="w-full px-4 py-3 border-2 rounded-lg" required><select class="w-full px-4 py-3 border-2 rounded-lg bg-white" name="gender1" required><option value="" disabled selected>æ€§åˆ«</option><option>ç”·</option><option>å¥³</option></select></div></div><div><label class="font-semibold text-gray-700">é˜Ÿå‘˜äºŒä¿¡æ¯ (æ‚¨çš„æ­æ¡£)</label><div class="space-y-3 mt-2 p-4 border rounded-lg"><input type="text" placeholder="å§“å" name="name2" class="w-full px-4 py-3 border-2 rounded-lg" required><input type="tel" placeholder="ç”µè¯" name="phone2" class="w-full px-4 py-3 border-2 rounded-lg" required><select class="w-full px-4 py-3 border-2 rounded-lg bg-white" name="gender2" required><option value="" disabled selected>æ€§åˆ«</option><option>ç”·</option><option>å¥³</option></select></div></div><button type="submit" class="w-full mt-4 lilly-button font-bold py-3 rounded-lg hover:opacity-90" style="background-color: #a855f7;">ç¡®è®¤æŠ¥å</button></form></div>
        <div class="sticky-footer"><button data-action="showPage" data-page="badmintonIntroPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">è¿”å›å¤§èµ›ä»‹ç»</button></div>
    </div>
    
    <!-- ç¾½æ¯›çƒæŠ¥åæˆåŠŸé¡µ -->
    <div id="badmintonSuccessPage" class="page">
        <div class="page-content text-center flex flex-col items-center justify-center">
             <div class="w-24 h-24 rounded-full flex items-center justify-center mb-6 mx-auto" style="background-color: var(--lilly-green-light);"><svg class="w-16 h-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
            <h2 class="text-3xl font-bold font-ringside" style="color: var(--lilly-red);">å¤§èµ›æŠ¥åæˆåŠŸ!</h2>
            <p class="text-gray-600 mt-2 mb-8">æ¯”èµ›ä¿¡æ¯å·²è®°å½•ï¼Œç°åœºå‡­å§“åç­¾åˆ°ã€‚</p>
            <div data-id="b-success-info" class="text-left w-full max-w-xs bg-gray-50 p-4 rounded-lg"></div>
        </div>
        <div class="sticky-footer space-y-2">
            <button data-action="showPage" data-page="badmintonIntroPage" class="w-full p-4 lilly-button rounded-xl text-center hover:opacity-90 transition font-semibold">è¿”å›å¤§èµ›ä»‹ç»</button>
            <button data-action="showMyBookings" class="w-full p-4 bg-gray-200 text-gray-800 rounded-xl text-center hover:bg-gray-300 transition font-semibold">æŸ¥çœ‹æˆ‘çš„æ‰€æœ‰æŠ¥å</button>
        </div>
    </div>

    <!-- æ‰‹ä½œå·¥åŠé¢„çº¦é¡µ -->
    <div id="craftsBookingPage" class="page">
        <div class="page-content !p-0 sm:!p-6">
            <div class="relative">
                <img src="https://images.unsplash.com/photo-1513364776144-60967b0f800f?q=80&w=1200&auto=format&fit=crop" class="w-full h-40 sm:h-56 object-cover sm:rounded-2xl">
                <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent sm:rounded-2xl"></div>
                <div class="absolute bottom-0 left-0 p-4 sm:p-6">
                    <h2 class="text-3xl font-bold font-ringside text-white">æ‰‹ä½œå·¥åŠé¢„çº¦</h2>
                    <p class="text-white/90 mt-1 text-sm">ä¸å®¶äººä¸€èµ·ï¼Œåˆ›é€ ç‹¬ä¸€æ— äºŒçš„æ¸©é¦¨å›å¿†</p>
                </div>
            </div>
            
            <div class="p-4 sm:p-0">
                <div class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 rounded-r-lg" data-id="craftsNotice">
                    <h3 class="font-bold">æŠ¥åé¡»çŸ¥</h3>
                    <ul class="list-disc list-inside text-sm mt-2 space-y-1">
                        <li>æ¯ä¸ªå®¶åº­æ€»å…±å¯åœ¨çº¿é¢„çº¦ <b>2</b> ä¸ªæ‰‹ä½œé¡¹ç›® (50%åé¢)ã€‚</li>
                        <li>å…¶ä¸­ï¼Œ<b>è€å¸ˆæŒ‡å¯¼è¯¾</b> ç”±äºåé¢æœ‰é™ï¼Œæ¯ä¸ªå®¶åº­æœ€å¤šåªèƒ½é€‰æ‹© <b>1</b> é¡¹ã€‚</li>
                        <li class="font-bold">è¯·å‡†æ—¶åˆ°åœºï¼é¢„çº¦è¯¾ç¨‹å¼€å§‹å‰5åˆ†é’Ÿä»æœªåˆ°åœºï¼Œåé¢å°†è‡ªåŠ¨é‡Šæ”¾ç»™ç°åœºç­‰å€™çš„å®¶åº­å“¦ï¼</li>
                    </ul>
                </div>
                <div data-id="craftsListContainer" class="mt-6 space-y-4">
                    <!-- JS will populate this -->
                </div>
            </div>
        </div>
        <div class="sticky-footer grid grid-cols-2 gap-4">
            <button data-action="showPage" data-page="mapPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">è¿”å›åœ°å›¾</button>
            <button data-action="submitCraftsBooking" class="w-full p-4 lilly-button rounded-xl text-center hover:opacity-90 transition font-semibold">ç¡®è®¤æˆ‘çš„é¢„çº¦</button>
        </div>
    </div>

    <!-- æ‰‹ä½œé¢„çº¦æˆåŠŸé¡µ -->
    <div id="craftsSuccessPage" class="page">
        <div class="page-content text-center flex flex-col items-center justify-center">
             <div class="w-24 h-24 rounded-full flex items-center justify-center mb-6 mx-auto" style="background-color: var(--lilly-green-light);"><svg class="w-16 h-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
            <h2 class="text-3xl font-bold font-ringside" style="color: var(--lilly-red);">æ‰‹ä½œé¢„çº¦æˆåŠŸ!</h2>
            <p class="text-gray-600 mt-2 mb-8">è¯·åœ¨é¢„çº¦æ—¶é—´å‰5åˆ†é’Ÿï¼Œå‡­â€œæˆ‘çš„å‡­è¯â€åˆ°åœºç­¾åˆ°ã€‚</p>
            <div data-id="c-success-info" class="text-left w-full max-w-sm bg-gray-50 p-4 rounded-lg"></div>
        </div>
        <div class="sticky-footer space-y-2">
            <button data-action="showPage" data-page="mapPage" class="w-full p-4 lilly-button rounded-xl text-center hover:opacity-90 transition font-semibold">è¿”å›åœ°å›¾é¦–é¡µ</button>
            <button data-action="showMyBookings" class="w-full p-4 bg-gray-200 text-gray-800 rounded-xl text-center hover:bg-gray-300 transition font-semibold">æŸ¥çœ‹æˆ‘çš„æ‰€æœ‰å‡­è¯</button>
        </div>
    </div>
</template>

<script>
    // é™æ€æ•°æ®
    const HIGHLIGHT_DATA = {
        event: { title: "ç™¾äººå¼€å›¢ï¼Œå°–å«æå‡»ï¼", text: "å¿˜æ‰æ‹˜æŸï¼Œé‡Šæ”¾å¤©æ€§ï¼å·¨å‹é“å…·å’Œè¶£å‘³è§„åˆ™ï¼Œè®©æ¯ä¸ªäººéƒ½èƒ½ç¬é—´èå…¥ï¼Œå¼•çˆ†å›¢é˜Ÿåä½œçš„æ— é™èƒ½é‡ï¼", img: "https://images.unsplash.com/photo-1593341641692-aa7a8a7f711b?q=80&w=2574&auto=format&fit=crop" },
        offroad: { title: "å¼•æ“è½°é¸£ï¼Œå°˜åœŸé£æ‰¬ï¼", text: "æƒ³ä½“éªŒä¸€æŠŠç°å®ç‰ˆçš„â€œé€Ÿåº¦ä¸æ¿€æƒ…â€å—ï¼Ÿæ¡ç´§æ–¹å‘ç›˜ï¼Œç©¿è¶Šå´å²–èµ›é“ï¼Œä½“éªŒè‚¾ä¸Šè…ºç´ é£™å‡çš„æè‡´å¿«æ„Ÿï¼", img: "https://images.unsplash.com/photo-1610479593531-c5d9a_b3b3f8?q=80&w=2574&auto=format&fit=crop" },
        party: { title: "å¤œå¹•é™ä¸´ï¼Œå‹è½´å¤§æˆï¼", text: "å½“ç¯ç«ç‚¹ç‡ƒï¼ŒéŸ³ä¹å“èµ·ï¼Œä¸€åœºçŒ®ç»™æ‰€æœ‰å®¶åº­çš„è‰åªæ´¾å¯¹æ­£å¼å¼€å§‹ã€‚å°½æƒ…èˆåŠ¨ï¼Œäº«å—æ­¤åˆ»çš„æƒ¬æ„ä¸è‡ªç”±ï¼", img: "https://images.unsplash.com/photo-1588124239333-594a73f403e3?q=80&w=2574&auto=format&fit=crop" },
        fireworks: { title: "ç‚¹äº®å¤œç©ºï¼Œå®šæ ¼ç’€ç’¨ï¼", text: "ä¸€åœºçŒ®ç»™æ‰€æœ‰å®¶åº­çš„ç’€ç’¨çƒŸèŠ±ç§€ï¼Œå°†ä¸ºä»Šå¤©ç”»ä¸Šæœ€äº®çš„æ„Ÿå¹å·ï¼æŠ¬å¤´ä»°æœ›ï¼Œå°†è¿™ä»½ç¾å¥½æ°¸è¿œçè—ã€‚", img: "https://images.unsplash.com/photo-1533294262438-2895680215a2?q=80&w=2574&auto=format&fit=crop" },
        picking: { title: "å¥”è·‘å§ï¼Œéƒ½å¸‚å†œå¤«ï¼", text: "é›†ç»“ï¼æ ¹æ®ç¥ç§˜ä»»åŠ¡å¡ï¼Œå†²å‘ç”°é‡ï¼Œå¯»æ‰¾æœ€æ–°é²œçš„æˆ˜åˆ©å“ã€‚é€Ÿåº¦æœ€å¿«çš„é˜Ÿä¼ï¼Œå°†èµ¢å¾—ä¸°æ”¶çš„è£è€€ï¼", img: "https://images.unsplash.com/photo-1567357504313-264259336946?q=80&w=2574&auto=format&fit=crop" }
    };

    const ACTIVITY_DATA = {
        fun: {
            title: "ã€Œè¶£ã€Â· å¥‡æƒ³ä¸–ç•Œ",
            items: [
                { id: 'fun-1', title: 'é›€ç¥äº‰éœ¸èµ›', subtitle: 'å·¨å‹éº»å°†ï¼Œå…¨å®¶å¼€æ ', desc: 'è¶…è¶…è¶…å¤§å·çš„éº»å°†ï¼Œè§è¿‡æ²¡ï¼Ÿæ¥è¿™é‡Œï¼Œä½ å°±æ˜¯ç‰Œæ¡Œä¸Šçš„å·¨äººï¼å…¨å®¶ä¸Šé˜µï¼Œä½“éªŒä¸€æŠŠâ€œæ ä¸Šå¼€èŠ±â€çš„éœ¸æ°”ï¼Œçœ‹çœ‹è°æ‰æ˜¯çœŸæ­£çš„é›€ç¥æœ¬ç¥ï¼', img: 'https://images.unsplash.com/photo-1591640242546-0b0b8c6c8e3f?q=80&w=2574&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1591640242546-0b0b8c6c8e3f?q=80&w=128&h=128&fit=crop', rules: '4äººä¸€ç»„ï¼Œæ¬¢ä¹å¼€å±€ï¼è§„åˆ™å’Œæ™®é€šéº»å°†ä¸€æ ·ç®€å•ï¼Œä½†å¿«ä¹æ˜¯PLUSç‰ˆçš„ï¼æ³¨æ„å“¦ï¼Œæ¨å€’ç‰Œå †å¯æ˜¯è¦æ¥å—å…¨å®¶äººçš„â€œå˜²ç¬‘â€æƒ©ç½šçš„ï¼' },
                { id: 'fun-2', title: 'ç–¯ç‹‚å¡ä¸è½¦', subtitle: 'ä½“éªŒé€Ÿåº¦çš„å¿«æ„Ÿ', desc: 'ç³»å¥½å®‰å…¨å¸¦ï¼Œè¸©ä¸‹æ²¹é—¨ï¼ŒæŠŠçƒ¦æ¼è¿œè¿œç”©åœ¨èº«åï¼è¿™é‡Œæ²¡æœ‰çº¢ç»¿ç¯ï¼Œåªæœ‰å¿ƒè·³å’Œå°–å«ï¼å¿«æ¥å’Œå®¶äººä¸€èµ·ï¼Œä¸Šæ¼”ä¸€åœºç°å®ç‰ˆçš„ã€Šé€Ÿåº¦ä¸æ¿€æƒ…ã€‹ï¼', img: 'https://images.unsplash.com/photo-1559137326-b8e7b1a8d1a5?q=80&w=2574&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1559137326-b8e7b1a8d1a5?q=80&w=128&h=128&fit=crop', rules: 'å®‰å…¨ç¬¬ä¸€ï¼Œæ¯”èµ›ç¬¬äºŒï¼æˆ´ä¸Šå¤´ç›”ï¼Œä½ å°±æ˜¯æœ€é“çš„ä»”ï¼åœ¨ä¸“å±èµ›é“é‡Œå°½æƒ…é©°éª‹ï¼Œç”¨æ¼‚äº®çš„æ¼‚ç§»å¾æœæ¯ä¸€ä¸ªå¼¯é“å§ï¼' },
                { id: 'fun-3', title: 'ç”°å›­å°ç«è½¦', subtitle: 'æ‚ é—²è§‚å…‰ä¹‹æ—…', desc: 'å‘œ~å‘œ~å¼€å¾€æ˜¥å¤©çš„ç«¥è¯åˆ—è½¦å³å°†å‘è½¦ï¼å¸¦ä¸Šçˆ¸çˆ¸å¦ˆå¦ˆï¼Œç©¿è¿‡ç»¿è‰²çš„ç”°é‡ï¼Œè·¯è¿‡å¯çˆ±çš„ç¨»è‰äººï¼Œäº«å—ä¸€æ®µè¢«é˜³å…‰å’Œå¾®é£åŒ…è£¹çš„æ‚ é—²æ—¶å…‰ã€‚', img: 'https://images.unsplash.com/photo-1533235898686-21f45f229ac5?q=80&w=2535&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1533235898686-21f45f229ac5?q=80&w=128&h=128&fit=crop', rules: 'è¯·æœ‰åºæ’é˜Ÿä¸Šè½¦ï¼Œåç¨³æ‰¶å¥½ã€‚å°ç«è½¦ä¼šå¸¦ä½ ç¯æ¸¸æ•´ä¸ªå†œåœºï¼Œè®°å¾—å‘çª—å¤–çš„å°åŠ¨ç‰©ä»¬æŒ¥æ‰‹é—®å¥½å‘€ï¼' },
                { id: 'fun-4', title: 'æ°´ä¸Šç¢°ç¢°èˆ¹', subtitle: 'å¤æ—¥æ¸…å‡‰å¤§ä½œæˆ˜', desc: 'å¤æ—¥ç‚ç‚ï¼Œç©æ°´æ‰æ˜¯æ­£ç»äº‹ï¼é©¾é©¶ä½ çš„ä¸“å±åº§é©¾ï¼Œåœ¨æ°´é¢ä¸Šæ¼”ä¸€åœºâ€œç¢°â€ç„¶å¿ƒåŠ¨çš„è¿½é€æˆ˜ï¼Œæ’èµ°æ‰€æœ‰ä¸å¼€å¿ƒï¼Œæ”¶è·ä¸€æ•´å¤©çš„æ¸…å‡‰ï¼', img: 'https://images.unsplash.com/photo-1534056220515-b2b35541105e?q=80&w=2574&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1534056220515-b2b35541105e?q=80&w=128&h=128&fit=crop', rules: 'ç©¿å¥½æ•‘ç”Ÿè¡£ï¼Œä½ å°±æ˜¯è¿™æ¡â€œæ²³â€æœ€é‡çš„å´½ï¼æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼šå‹å¥½åœ°â€œæ”»å‡»â€å¯¹æ–¹çš„èˆ¹åªï¼Œæ¯”æ¯”è°çš„æ°´ä¸Šæ¼‚ç§»æŠ€æœ¯æ›´èƒœä¸€ç­¹ï¼' },
            ]
        },
        win: {
            title: "ã€Œèµ¢ã€Â· å¡è·¯é‡Œæˆ˜åœº",
            items: [
                { id: 'win-1', title: 'è¿›å‡»çš„è·³è¿œ', subtitle: 'è¿æ°”ä¸å‹‡æ°”çš„å¯¹å†³', desc: 'è¿™ä¸æ˜¯æ™®é€šçš„è·³è¿œï¼Œè¿™æ˜¯ä¸€åœºå‹‡æ°”ã€æ™ºæ…§å’Œè¿æ°”çš„ç»ˆæå¯¹å†³ï¼åœ¨ä¸æ–­å»¶ä¼¸çš„èµ›é“ä¸Šï¼Œä½ å’Œå¯¹æ‰‹ç‹­è·¯ç›¸é€¢ï¼ŒçŒœæ‹³å†³å®šè°æ˜¯ç‹è€…ï¼', img: 'https://images.unsplash.com/photo-1571008781613-581373c09930?q=80&w=2574&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1571008781613-581373c09930?q=80&w=128&h=128&fit=crop', rules: 'çŸ³å¤´å‰ªåˆ€å¸ƒï¼Œä¸€å†³èƒœè´Ÿï¼è·³åˆ°å¯¹æ‰‹é¢å‰ï¼Œèµ¢å®¶ç»§ç»­å‰è¿›ï¼Œè¾“å®¶â€¦â€¦æ¢é˜Ÿå‹ä»å¤´å†æ¥ï¼å…ˆå é¢†å¯¹æ–¹å¤§æœ¬è¥çš„é˜Ÿä¼ï¼Œå°±æ˜¯æœ€ç»ˆçš„å† å†›ï¼' },
                { id: 'win-2', title: 'å·¨å‹æ’çƒå¯¹æŠ—èµ›', subtitle: 'è¶…ä¹æƒ³è±¡çš„å›¢é˜Ÿä¹è¶£', desc: 'æ¯”ä½ æƒ³è±¡ä¸­è¿˜å¤§çš„å·¨å‹æ’çƒæ¥å•¦ï¼è¿™è€ƒéªŒçš„ä¸æ˜¯çƒæŠ€ï¼Œæ˜¯å›¢é˜Ÿçš„å¿ƒè·³åŒæ­¥ç‡ï¼æ¯ä¸€æ¬¡æ‰˜ä¸¾ï¼Œæ¯ä¸€æ¬¡ä¼ é€’ï¼Œéƒ½æ˜¯æˆ‘ä»¬é»˜å¥‘çš„è¯æ˜ã€‚å¾—åˆ†ç¬é—´ï¼Œç‡ƒçˆ†å…¨åœºï¼', img: 'https://images.unsplash.com/photo-1612872087720-bb876e2e67d1?q=80&w=2574&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1612872087720-bb876e2e67d1?q=80&w=128&h=128&fit=crop', rules: 'å›¢ç»“å°±æ˜¯åŠ›é‡ï¼å…¨é˜Ÿé½å¿ƒååŠ›ï¼ŒæŠŠè¿™ä¸ªâ€œåºç„¶å¤§ç‰©â€æ‹è¿‡ç½‘ï¼Œè½åœ°å°±ç®—å¾—åˆ†ï¼æ¸©é¦¨æç¤ºï¼šå°å¿ƒè¢«çƒç ¸åˆ°å“¦ï¼Œå®ƒçœŸçš„å¾ˆå¤§ï¼' },
            ]
        },
        diy: {
            title: "ã€Œä½œã€Â· æ…¢æ—¶å…‰å·¥åŠ",
            items: [
                 { id: 'diy-1', title: 'æ‰­æ‰­æ£’DIY', category: 'A', subtitle: 'åŒ–èº«å¦™è¶£æ‰‹å·¥â€œèŠ±â€åŒ ', desc: 'è°è¯´é²œèŠ±åªèƒ½å»èŠ±åº—ä¹°ï¼Ÿåœ¨è¿™é‡Œï¼Œå‡ æ ¹æ¯›èŒ¸èŒ¸çš„æ‰­æ‰­æ£’ï¼Œå°±èƒ½åœ¨ä½ æ‰‹ä¸­ç»½æ”¾å‡ºæ°¸ä¸å‡‹è°¢çš„â€œèŠ±â€ä¸â€œåŒ å¿ƒâ€ã€‚å¿«æ¥åŒ–èº«æ‰‹å·¥é­”æ³•å¸ˆï¼Œåˆ›é€ ä½ çš„ä¸“å±èŠ±æŸå§ï¼', img: 'https://images.unsplash.com/photo-1678822369408-e3a88a882a9d?q=80&w=1200&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1678822369408-e3a88a882a9d?q=80&w=128&h=128&fit=crop', rules: 'é¢†å–ä½ çš„â€œé­”æ³•æ£’â€ï¼ˆæ‰­æ‰­æ£’ææ–™åŒ…ï¼‰ï¼Œè·Ÿç€æ„Ÿè§‰èµ°ï¼ä½ å¯ä»¥è‡ªç”±åˆ›ä½œï¼Œä¹Ÿå¯ä»¥å‚è€ƒæˆ‘ä»¬çš„çµæ„Ÿå›¾å†Œã€‚é‡åˆ°å›°éš¾ï¼Ÿéšæ—¶å‘¼å«æˆ‘ä»¬çš„æŒ‡å¯¼å°è€å¸ˆå“¦ï¼', duration: 40, capacity: 15, onlineTotal: 22, sessions: ['15:45-16:25', '16:30-17:10', '17:15-17:55']},
                 { id: 'diy-2', title: 'æ²™ç”»/å¡«ç»˜DIY', category: 'A', subtitle: 'ç”¨è‰²å½©æç»˜ç«¥çœŸ', desc: 'ç”¨äº”å½©æ–‘æ–“çš„æ²™å­ï¼Œæç»˜å¿ƒä¸­çš„ç«¥è¯ä¸–ç•Œã€‚ä¸€å±‚ä¸€å±‚ï¼Œä¸€ç¬”ä¸€ç”»ï¼Œå°†æƒ³è±¡åŠ›ä¸ä¸“æ³¨åŠ›èåˆï¼Œåˆ›ä½œä¸€å¹…ç‹¬ä¸€æ— äºŒã€å¯ä»¥å¸¦å›å®¶çš„ç²¾ç¾æ²™ç”»è‰ºæœ¯å“ã€‚', img: 'https://images.unsplash.com/photo-1599408285942-03f194723438?q=80&w=1200&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1599408285942-03f194723438?q=80&w=128&h=128&fit=crop', rules: 'é€‰æ‹©ä½ å¿ƒä»ªçš„ç”»æ¿ï¼Œç„¶åå¤§èƒ†åœ°ç©å¼„è‰²å½©å§ï¼å…ˆæ’•æ‰å“ªå—ä¸å¹²èƒ¶ï¼Œå°±å…ˆæ’’ä¸Šå“ªç§é¢œè‰²çš„æ²™å­ï¼Œè½»è½»ä¸€æŠ–ï¼ŒæƒŠå–œå°±å‡ºç°å•¦ï¼', duration: 40, capacity: 15, onlineTotal: 22, sessions: ['15:45-16:25', '16:30-17:10', '17:15-17:55']},
                 { id: 'diy-3', title: 'æä¸çç…DIY', category: 'B', subtitle: 'å°å­˜æ­¤åˆ»çš„ç¾å¥½', desc: 'ä½“éªŒä¸€æ¬¡ç©¿è¶Šåƒå¹´çš„å®«å»·æŠ€è‰ºï¼ç”¨é‡‘è‰²çš„ä¸çº¿å‹¾å‹’è½®å»“ï¼Œå†å¡«å…¥ç»šçƒ‚çš„çç…å½©ï¼Œäº²æ‰‹å°å­˜ä¸€ä»½å¤å…¸ä¸ç°ä»£äº¤ç»‡çš„ç¾å¥½ã€‚æˆå“ç»å¯¹æƒŠè‰³ä½ çš„æœ‹å‹åœˆï¼', img: 'https://images.unsplash.com/photo-1629910229818-f25b4b3a6288?q=80&w=1200&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1629910229818-f25b4b3a6288?q=80&w=128&h=128&fit=crop', rules: 'ç¬¬ä¸€æ­¥ï¼Œç”¨å·§åŠ²å„¿å°†é“œä¸â€œæâ€å‡ºä½ å–œæ¬¢çš„å›¾æ¡ˆã€‚ç¬¬äºŒæ­¥ï¼Œåƒå¡«è‰²æ¸¸æˆä¸€æ ·ï¼Œç”¨æ»´ç®¡æŠŠå½©ç ‚å¡«å…¥ç©ºç™½å¤„ã€‚æœ€åä¸€æ­¥ï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€æ­¥ï¼šæ‹ç…§ç•™å¿µï¼', duration: 30, capacity: 14, onlineTotal: 28, sessions: ['15:45-16:15', '16:20-16:50', '16:55-17:25', '17:30-18:00']},
                 { id: 'diy-4', title: 'æ‰‹ç»˜é£é“ƒDIY', category: 'B', subtitle: 'äº²æ‰‹ç»˜åˆ¶å¤æ—¥ä¹‹å£°', desc: 'å¤å¤©æ˜¯ä»€ä¹ˆå£°éŸ³ï¼Ÿæ˜¯å†°è¥¿ç“œçš„ç”œï¼Œä¹Ÿæ˜¯é£é“ƒçš„è„†ã€‚æ‹¿èµ·ç”»ç¬”ï¼Œåœ¨æ¸…é€çš„ç»ç’ƒé£é“ƒä¸Šï¼Œç”»ä¸‹å±äºä½ çš„å¤æ—¥å¯†è¯­ï¼Œè®©æ¯ä¸€æ¬¡æ¸…é£æ‹‚è¿‡ï¼Œéƒ½ä¸ºä½ å¥å“ä¸“å±çš„æ—‹å¾‹ã€‚', img: 'https://images.unsplash.com/photo-1596791694931-e6a88b201584?q=80&w=1200&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1596791694931-e6a88b201584?q=80&w=128&h=128&fit=crop', rules: 'å¤§èƒ†å‘æŒ¥ä½ çš„è‰ºæœ¯ç»†èƒï¼ç”¨ç‰¹åˆ¶çš„é¢œæ–™åœ¨ç»ç’ƒé£é“ƒä¸Šå°½æƒ…åˆ›ä½œã€‚ç”»å®Œåè®°å¾—è¦è®©å®ƒè‡ªç„¶é£å¹²ï¼Œæ‰èƒ½æŠŠè¿™ä»½â€œå¤å¤©çš„å£°éŸ³â€å®Œå¥½æ— æŸåœ°å¸¦å›å®¶å“¦ã€‚', duration: 30, capacity: 14, onlineTotal: 28, sessions: ['15:45-16:15', '16:20-16:50', '16:55-17:25', '17:30-18:00']},
                 { id: 'diy-5', title: 'é©¬èµ›å…‹ç¯DIY', category: 'B', subtitle: 'ç‚¹äº®å¼‚åŸŸé£æƒ…', desc: 'ä¸€ç§’ç©¿è¶Šåˆ°åœŸè€³å…¶ï¼äº²æ‰‹æ‹¼è´´äº”å½©çš„ç‰ç’ƒç‰‡ï¼Œåœ¨å…‰å½±äº¤é”™é—´ï¼Œç‚¹äº®ä¸€ç›å……æ»¡å¼‚åŸŸé£æƒ…çš„é©¬èµ›å…‹ç¯ã€‚å½“ç¯å…‰äº®èµ·ï¼Œæ•´ä¸ªæˆ¿é—´éƒ½å°†å˜å¾—æ¸©æŸ”åˆæµªæ¼«ã€‚', img: 'https://images.unsplash.com/photo-1577579401824-9b57c667b34b?q=80&w=1200&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1577579401824-9b57c667b34b?q=80&w=128&h=128&fit=crop', rules: 'å‘æŒ¥ä½ çš„è‰²å½©æ­é…å¤©èµ‹ï¼å°†äº”å½©çš„ç»ç’ƒç‰‡ï¼Œç”¨èƒ¶æ°´ç²˜è´´åœ¨ç¯ç½©ä¸Šï¼Œç»„æˆä½ å–œæ¬¢çš„å›¾æ¡ˆã€‚è´´æ»¡åï¼Œäº¤ç»™æˆ‘ä»¬çš„å·¥ä½œäººå‘˜è¿›è¡Œæœ€åçš„çŒæµ†å›ºå®šå°±å¤§åŠŸå‘Šæˆå•¦ï¼', duration: 30, capacity: 14, onlineTotal: 28, sessions: ['15:45-16:15', '16:20-16:50', '16:55-17:25', '17:30-18:00']}
            ]
        },
    };

     const SCRATCH_THEMES = {
        fun: {
            bg: 'url("https://images.unsplash.com/photo-1520466487548-9c59d4a88f57?q=80&w=2574&auto=format&fit=crop")',
            positions: [{top: '15%', left: '5%'}, {top: '35%', left: '50%'}, {top: '60%', left: '15%'}, {top: '75%', left: '45%'}]
        },
        win: {
            bg: 'url("https://images.unsplash.com/photo-1579952516518-6c85a2134cbe?q=80&w=2574&auto=format&fit=crop")',
            positions: [{top: '25%', left: '15%'}, {top: '55%', left: '55%'}]
        },
        diy: {
            bg: 'url("https://images.unsplash.com/photo-1541251323365-2947715f1647?q=80&w=2574&auto=format&fit=crop")',
            positions: [{top: '10%', left: '5%'}, {top: '30%', left: '50%'}, {top: '50%', left: '15%'}, {top: '70%', left: '55%'}, {top: '85%', left: '25%'}]
        }
    };

    class H5App {
        constructor(rootId) {
            this.root = document.getElementById(rootId);
            this.appTemplate = document.getElementById('app-template');
            this.root.innerHTML = this.appTemplate.innerHTML;
            
            this.modal = document.getElementById('customModal');
            this.exploreModal = document.getElementById('exploreModal');

            this.state = {
                currentUser: null,
                currentPage: 'splashPage',
                currentScratchType: null,
                registrationData: null,
                tournamentRegistrationData: { mens: [], womens: [], mixed: [] },
                craftsBookingData: [], // Now an array for multiple bookings
                // SIMULATED BACKEND DATA for craft bookings
                allCraftsBookings: [], 
            };

            this.init();
        }

        getEl(dataId) {
            return document.querySelector(`[data-id="${dataId}"]`);
        }
        getAllEl(selector) {
            return document.querySelectorAll(selector);
        }

        init() {
            this.loadState();
            this.simulateInitialBookings(); // Simulate other users booking
            this.attachEventListeners();
            
            if (this.state.currentUser) {
                this.showPage('mapPage');
            } else {
                this.showPage('splashPage');
            }
        }
        
        // Simulate other people having booked some slots already
        simulateInitialBookings() {
            if (this.state.allCraftsBookings.length === 0) { // Only run once
                this.state.allCraftsBookings.push({id: 'diy-1', session: '15:45-16:25'});
                this.state.allCraftsBookings.push({id: 'diy-1', session: '15:45-16:25'});
                this.state.allCraftsBookings.push({id: 'diy-3', session: '16:20-16:50'});
                this.state.allCraftsBookings.push({id: 'diy-3', session: '16:20-16:50'});
                this.state.allCraftsBookings.push({id: 'diy-5', session: '17:30-18:00'});
                this.state.allCraftsBookings.push({id: 'diy-4', session: '16:20-16:50'}); // Not making it full anymore
                this.saveState();
            }
        }

        attachEventListeners() {
            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                const action = target.dataset.action;
                if (typeof this[action] === 'function') {
                    this[action](target, e);
                }
            });
            
             document.body.addEventListener('click', (e) => {
                const radio = e.target.closest('.craft-session-radio');
                if (radio) {
                    this.handleCraftsSelection(radio);
                }
            }, true);


            this.getAllEl('.badminton-reg-page form').forEach(form => {
                form.addEventListener('submit', (e) => this.handleBadmintonRegistration(e));
            });

            this.getAllEl('input[name="transport"]').forEach(radio => {
                radio.addEventListener('change', (e) => this.updateTransportInfo(e.target.value));
            });
        }
        
        showPage(target) {
            const pageId = typeof target === 'string' ? target : target.dataset.page;
            if(!pageId) return;

            this.state.currentPage = pageId;
            this.getAllEl('.page').forEach(p => p.style.display = 'none');
            const targetPage = this.root.querySelector(`#${pageId}`);
            
            if (targetPage) {
                targetPage.style.display = 'flex';
            }
            this.root.parentElement.scrollTo(0, 0);

            // Page-specific logic
            if (pageId === 'registrationPage' && this.state.currentUser) { this.populateRegistrationForm(); }
            if (pageId === 'badmintonIntroPage') { this.updateBadmintonCounts(); }
            if (pageId === 'craftsBookingPage') { this.populateCraftsBookingPage(); }
        }
        
        saveState() {
            localStorage.setItem('lillyFamilyDayState', JSON.stringify(this.state));
        }

        loadState() {
            const savedState = localStorage.getItem('lillyFamilyDayState');
            if (savedState) {
                const loaded = JSON.parse(savedState);
                // Ensure new state properties exist
                this.state = {
                    ...{
                        allCraftsBookings: [], 
                        craftsBookingData: [],
                        tournamentRegistrationData: { mens: [], womens: [], mixed: [] }
                    },
                    ...loaded
                };
            }
        }

        verifyEmployee() {
            const id = this.getEl('employeeIdInput').value.trim();
            const name = this.getEl('employeeNameInput').value.trim();
            const phone = this.getEl('employeePhoneInput').value.trim();
            const errorEl = this.getEl('verificationError');

            if (/^1[3-9]\d{9}$/.test(phone) && id && name) {
                errorEl.textContent = '';
                this.state.currentUser = { id, name, phone };
                this.saveState();
                this.showPage('mapPage');
            } else {
                 errorEl.textContent = 'è¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯æ˜¯å¦å®Œæ•´æˆ–æ‰‹æœºå·æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚';
            }
        }
        
        populateRegistrationForm() {
            if (!this.state.currentUser) return;
            this.getEl('regEmployeeId').textContent = this.state.currentUser.id;
            this.getEl('regEmployeeName').textContent = this.state.currentUser.name;
            this.getEl('regEmployeePhone').textContent = this.state.currentUser.phone;
            this.getEl('familyFormsContainer').innerHTML = '';
        }

        submitRegistration() {
            const familyMembers = [];
            this.getAllEl('.family-member-form').forEach(form => {
                const name = form.querySelector('input[name="familyName"]').value.trim();
                const relation = form.querySelector('select[name="familyRelation"]').value;
                if (name && relation) {
                    familyMembers.push({ name, relation });
                }
            });

            const dining = this.root.querySelector('input[name="dining"]:checked').value;
            const transport = this.root.querySelector('input[name="transport"]:checked').value;

            this.state.registrationData = {
                employee: this.state.currentUser,
                family: familyMembers,
                dining,
                transport
            };
            this.saveState();
            this.updateSuccessPage();
            this.showPage('successPage');
        }

        updateSuccessPage() {
            if (!this.state.registrationData || !this.state.currentUser) return;
            
            const { employee } = this.state.registrationData;
            const qrData = encodeURIComponent(JSON.stringify(this.state.registrationData));
            
            this.getEl('qrCode').src = `https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${qrData}`;
            this.getEl('successName').textContent = employee.name;
            this.getEl('successId').textContent = `å·¥å·: ${employee.id}`;
            
            this.updateMyBookingsPage();
        }

        showMyBookings() {
            if (this.state.registrationData) {
                this.updateSuccessPage();
                this.showPage('successPage');
            } else {
                this.showModal('æç¤º', 'æ‚¨è¿˜æ²¡æœ‰æŠ¥åå®¶åº­æ—¥æ´»åŠ¨ï¼Œè¯·å…ˆæŠ¥åã€‚');
            }
        }
        
        updateMyBookingsPage() {
            let bookingsHtml = `<h4 class="font-bold mb-2 text-gray-800">æˆ‘çš„å®¶åº­æ—¥å‡­è¯</h4>`;
            if (this.state.registrationData) {
                const { family, dining, transport } = this.state.registrationData;
                const familyText = family.length > 0 ? `<strong>åŒè¡Œå®¶å± (${family.length}ä½):</strong> ${family.map(f => `${f.name}(${f.relation})`).join(', ')}` : '<strong>åŒè¡Œå®¶å±:</strong> æ— ';
                bookingsHtml += `
                    <p class="text-sm"><strong>ç”¨é¤æ‰¹æ¬¡:</strong> ${dining}</p>
                    <p class="text-sm"><strong>å‡ºè¡Œæ–¹å¼:</strong> ${transport}</p>
                    <p class="text-sm">${familyText}</p>
                `;
            }

            if (this.state.craftsBookingData && this.state.craftsBookingData.length > 0) {
                bookingsHtml += `<hr class="my-3"> <h4 class="font-bold mb-2 text-gray-800">æˆ‘çš„æ‰‹ä½œé¢„çº¦</h4>`;
                this.state.craftsBookingData.forEach(booking => {
                     bookingsHtml += `<p class="text-sm"><strong>${booking.title}:</strong> ${booking.session}</p>`;
                });
            }

            const { mens, womens, mixed } = this.state.tournamentRegistrationData;
            const hasTournamentReg = mens.length > 0 || womens.length > 0 || mixed.length > 0;
            if(hasTournamentReg){
                 bookingsHtml += `<hr class="my-3"> <h4 class="font-bold mb-2 text-gray-800">æˆ‘çš„èµ›äº‹æŠ¥å</h4>`;
                 if (mens.length > 0) bookingsHtml += `<p class="text-sm"><strong>ç”·å•:</strong> ${mens.map(p => p.name1).join(', ')}</p>`;
                 if (womens.length > 0) bookingsHtml += `<p class="text-sm"><strong>å¥³å•:</strong> ${womens.map(p => p.name1).join(', ')}</p>`;
                 if (mixed.length > 0) bookingsHtml += `<p class="text-sm"><strong>æ··åŒ:</strong> ${mixed.map(p => `${p.name1}/${p.name2}`).join(', ')}</p>`;
            }
            this.getEl('allMyBookings').innerHTML = bookingsHtml;
        }


        addFamilyMemberForm() {
            const container = this.getEl('familyFormsContainer');
            const formHtml = `
                <div class="family-member-form flex gap-2 items-center border-b pb-3">
                    <input type="text" name="familyName" placeholder="å®¶å±å§“å" class="w-full px-3 py-2 border rounded-md text-sm" required>
                    <select name="familyRelation" class="w-full px-3 py-2 border rounded-md bg-white text-sm" required>
                        <option value="" disabled selected>å…³ç³»</option>
                        <option>é…å¶</option><option>å­å¥³</option><option>çˆ¶æ¯</option><option>å…¶ä»–</option>
                    </select>
                    <button data-action="removeFamilyMember" class="p-2 bg-red-100 text-red-600 rounded-full hover:bg-red-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', formHtml);
        }

        removeFamilyMember(target) {
            target.closest('.family-member-form').remove();
        }

        updateTransportInfo(transportValue) {
            const detailsEl = this.getEl('transportDetails');
            if (transportValue === 'å…¬å¸å¤§å·´') {
                detailsEl.style.display = 'block';
            } else {
                detailsEl.style.display = 'none';
            }
        }
        
        showModal(title, text, imgSrc = null) {
            this.modal.querySelector('[data-id="modalTitle"]').textContent = title;
            this.modal.querySelector('[data-id="modalText"]').textContent = text;
            const imgContainer = this.modal.querySelector('.modal-image-container');
            const imgEl = this.modal.querySelector('[data-id="modalImage"]');
            
            if (imgSrc) {
                imgEl.src = imgSrc;
                imgContainer.style.display = 'block';
            } else {
                imgContainer.style.display = 'none';
            }
            
            this.modal.classList.add('visible');
            this.modal.querySelector('[data-id="modalCloseBtn"]').onclick = () => this.hideModal();
        }

        hideModal() {
            this.modal.classList.remove('visible');
        }

        showHighlight(target) {
            const highlightKey = target.dataset.highlight;
            const data = HIGHLIGHT_DATA[highlightKey];
            if (data) {
                this.showModal(data.title, data.text, data.img);
            }
        }
        
        showPhotoAlbum() {
            this.showModal('æ•¬è¯·æœŸå¾…', 'â€œç²¾å½©ç¬é—´â€äº‘ç›¸å†ŒåŠŸèƒ½å°†åœ¨æ´»åŠ¨å½“æ—¥ä¸Šçº¿ï¼Œä¸ºæ‚¨è®°å½•æ¯ä¸€ä¸ªæ¬¢ä¹æ—¶åˆ»ï¼');
        }

        openExploreModal() {
            this.exploreModal.classList.add('visible');
        }
        closeExploreModal() {
            this.exploreModal.classList.remove('visible');
        }

        showScratchPage(target) {
            const type = target.dataset.type;
            const data = ACTIVITY_DATA[type];
            const theme = SCRATCH_THEMES[type];

            this.state.currentScratchType = type;
            this.getEl('scratchTitle').textContent = data.title;
            const scratchContent = this.getEl('scratchContent');
            
            scratchContent.style.backgroundImage = theme.bg;
            scratchContent.style.backgroundSize = 'cover';
            scratchContent.style.backgroundPosition = 'center';
            scratchContent.style.minHeight = '500px';
            scratchContent.style.position = 'relative';
            scratchContent.classList.remove('p-4', 'bg-gray-50');

            const container = this.getEl('activityListContainer');
            container.className = 'w-full h-full'; // Reset classes
            container.innerHTML = data.items.map((item, index) => {
                const pos = theme.positions[index % theme.positions.length];
                return `
                    <div data-action="showItemDetail" data-item-id="${item.id}" data-type="${type}" class="themed-activity-card" style="top: ${pos.top}; left: ${pos.left};">
                        <img src="${item.thumb}" alt="${item.title}">
                        <div>
                            <h4>${item.title}</h4>
                            <p>${item.subtitle}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            this.closeExploreModal();
            this.showPage('scratchPage');
            this.initScratchCard();
        }
        
        closeScratchPage() {
            this.openExploreModal();
        }

        initScratchCard() {
            const container = this.getEl('scratchContainer');
            const canvas = this.getEl('scratchCanvas');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
        
            const getBrushPos = (x, y) => {
                const rect = canvas.getBoundingClientRect();
                return { x: x - rect.left, y: y - rect.top };
            }
        
            const draw = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = e.touches ? getBrushPos(e.touches[0].clientX, e.touches[0].clientY) : getBrushPos(e.clientX, e.clientY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }
        
            const start = (e) => {
                isDrawing = true;
                const pos = e.touches ? getBrushPos(e.touches[0].clientX, e.touches[0].clientY) : getBrushPos(e.clientX, e.clientY);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            }
        
            const finish = () => { isDrawing = false; }
            
             const checkClickThrough = (e) => {
                const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                
                canvas.style.pointerEvents = 'none';
                const underlyingElement = document.elementFromPoint(clientX, clientY);
                canvas.style.pointerEvents = 'auto'; 
                
                if (underlyingElement && underlyingElement.closest('[data-action]')) {
                   underlyingElement.closest('[data-action]').click();
                }
            }

            const resizeCanvas = () => {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                canvas.style.display = 'block';
                canvas.style.opacity = '1';
                canvas.style.pointerEvents = 'auto';
                ctx.fillStyle = '#ddd';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = Math.max(canvas.width, canvas.height) * 0.1;
                ctx.lineCap = 'round';
            }
            resizeCanvas();

            // Simplified event listeners
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', finish);
            canvas.addEventListener('click', checkClickThrough);

            canvas.addEventListener('touchstart', start, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', (e) => {
                finish();
                checkClickThrough(e);
            });
        }
        
        showItemDetail(target) {
            const itemId = target.dataset.itemId;
            const type = target.dataset.type;
            const item = ACTIVITY_DATA[type].items.find(i => i.id === itemId);

            if (item) {
                this.getEl('itemDetailImage').src = item.img;
                this.getEl('itemDetailTitle').textContent = item.title;
                this.getEl('itemDetailDescription').textContent = item.desc;
                this.getEl('itemDetailRules').textContent = item.rules;
                this.getEl('itemDetailBackButton').dataset.type = type;
                this.showPage('itemDetailPage');
            }
        }
        
        returnToScratchPage() {
            this.showPage('scratchPage');
        }

        handleBadmintonRegistration(event) {
             event.preventDefault();
             const form = event.target;
             const type = form.dataset.type;
             const formData = new FormData(form);
             const data = Object.fromEntries(formData.entries());

             const isAlreadyRegistered = this.state.tournamentRegistrationData[type].some(p => p.name1 === data.name1);
             if(isAlreadyRegistered){
                this.showModal('é‡å¤æŠ¥å', 'æ‚¨å·²ç»æŠ¥è¿‡æ­¤é¡¹ç›®äº†ï¼Œæ— éœ€é‡å¤æŠ¥åã€‚');
                return;
             }

             if(type === 'mixed' && data.gender1 === data.gender2){
                 this.showModal('æŠ¥åæç¤º', 'æ··åˆåŒæ‰“é¡¹ç›®ï¼Œå»ºè®®é€‰æ‹©ä¸åŒæ€§åˆ«çš„æ­æ¡£å“¦ã€‚');
             }

             this.state.tournamentRegistrationData[type].push(data);
             this.saveState();
             
             const successInfoEl = this.getEl('b-success-info');
             if(type === 'mixed'){
                 successInfoEl.innerHTML = `<p><strong>é¡¹ç›®:</strong> æ··åˆåŒæ‰“</p><p><strong>é˜Ÿå‘˜:</strong> ${data.name1} / ${data.name2}</p>`;
             } else {
                 successInfoEl.innerHTML = `<p><strong>é¡¹ç›®:</strong> ${type === 'mens' ? 'ç”·å­å•æ‰“' : 'å¥³å­å•æ‰“'}</p><p><strong>é€‰æ‰‹:</strong> ${data.name1}</p>`;
             }
             this.showPage('badmintonSuccessPage');
        }

        updateBadmintonCounts() {
            const limits = { mens: 16, womens: 16, mixed: 16 };
            for(const type in limits){
                const count = this.state.tournamentRegistrationData[type].length;
                const remain = limits[type] - count;
                this.getEl(`${type}_count`).textContent = count;
                this.getEl(`${type}_remain`).textContent = remain > 0 ? remain : 0;
            }
        }
        
        showBadmintonRegPage(target) {
             if (!this.state.registrationData) {
                this.showModal('æŠ¥åé™åˆ¶', 'è¯·æ‚¨å…ˆå®Œæˆå®¶åº­æ—¥æ´»åŠ¨æŠ¥åï¼Œæ‰èƒ½æŠ¥åç¾½æ¯›çƒå¤§èµ›å“¦ï¼');
                return;
            }
            this.showPage(target.dataset.page);
        }

        // --- CRAFTS BOOKING LOGIC ---
        populateCraftsBookingPage() {
            const container = this.getEl('craftsListContainer');
            const items = ACTIVITY_DATA.diy.items;
            
            // Distribute total online slots evenly among sessions
            items.forEach(item => {
                const slotsPerSession = Math.floor(item.onlineTotal / item.sessions.length);
                let remainder = item.onlineTotal % item.sessions.length;
                item.sessionCapacity = item.sessions.map(() => {
                    let capacity = slotsPerSession;
                    if (remainder > 0) {
                        capacity++;
                        remainder--;
                    }
                    return capacity;
                });
            });

            container.innerHTML = items.map(item => {
                let sessionsHtml = item.sessions.map((session, index) => {
                    const isChecked = this.state.craftsBookingData.some(b => b.id === item.id && b.session === session);
                    const bookedCount = this.state.allCraftsBookings.filter(b => b.id === item.id && b.session === session).length;
                    const capacity = item.sessionCapacity[index];
                    const remaining = capacity - bookedCount;

                    return `
                        <label class="flex items-center justify-center text-center p-2 border rounded-lg has-[:checked]:bg-green-50 has-[:checked]:border-green-600 has-[:checked]:text-green-800 has-[:checked]:font-semibold cursor-pointer transition-all">
                            <input type="radio" name="session_${item.id}" value="${session}" ${isChecked ? 'checked' : ''} ${remaining <= 0 ? 'disabled' : ''} class="craft-session-radio hidden" data-id="${item.id}" data-category="${item.category}" data-title="${item.title}">
                             <span class="text-sm">${session} <span class="text-xs ${remaining > 0 ? 'text-gray-500' : 'text-red-500'}">(ä½™${remaining})</span></span>
                        </label>
                    `;
                }).join('');

                return `
                    <div class="event-card" data-category="${item.category}">
                       <div class="event-card-header">
                            <h4 class="font-bold font-ringside text-lg">${item.title}</h4>
                            <div class="flex items-center justify-between text-sm text-gray-500 mt-1">
                                <span>å•åœºæ—¶é•¿: ${item.duration}åˆ†é’Ÿ</span>
                                <span>å•åœºæ¥å¾…: ${item.capacity}ç»„å®¶åº­</span>
                                <span class="text-xs font-semibold ${item.category === 'A' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'} px-2 py-1 rounded-full">${item.category === 'A' ? 'è€å¸ˆæŒ‡å¯¼' : 'è‡ªç”±ä½“éªŒ'}</span>
                            </div>
                       </div>
                        <div class="event-card-body">
                           <div class="session-grid">${sessionsHtml}</div>
                        </div>
                    </div>
                `;
            }).join('');
            this.handleCraftsSelection();
        }
        
        handleCraftsSelection(clickedRadio = null) {
            if (clickedRadio) {
                const booking = {
                    id: clickedRadio.dataset.id,
                    title: clickedRadio.dataset.title,
                    session: clickedRadio.value,
                    category: clickedRadio.dataset.category,
                };
                const existingIndex = this.state.craftsBookingData.findIndex(b => b.id === booking.id && b.session === booking.session);

                if (existingIndex > -1) { // It was a deselection
                    this.state.craftsBookingData.splice(existingIndex, 1);
                } else { // It was a selection
                    this.state.craftsBookingData.push(booking);
                }
                // Sync radio checked state with the data model
                this.getAllEl('.craft-session-radio').forEach(radio => {
                    radio.checked = this.state.craftsBookingData.some(b => b.id === radio.dataset.id && b.session === radio.value);
                });
            }

            // Apply rules
            const allRadios = this.getAllEl('.craft-session-radio');
            const selectedCount = this.state.craftsBookingData.length;
            const selectedACount = this.state.craftsBookingData.filter(b => b.category === 'A').length;

            allRadios.forEach(radio => {
                const isChecked = radio.checked;
                const isA = radio.dataset.category === 'A';
                 const remainingText = radio.nextElementSibling.querySelector('span').textContent;
                const isFull = remainingText.includes('(ä½™0)');

                let shouldDisable = false;
                if (!isChecked) {
                    if (selectedCount >= 2) {
                        shouldDisable = true;
                    } else if (selectedACount >= 1 && isA) {
                        shouldDisable = true;
                    }
                }
                
                if (isFull) shouldDisable = true;

                radio.disabled = shouldDisable;
                radio.closest('label').classList.toggle('opacity-50', shouldDisable && !isFull);
                radio.closest('label').classList.toggle('cursor-not-allowed', shouldDisable);
                radio.closest('label').classList.toggle('!bg-gray-100', shouldDisable && !isFull);
                radio.closest('label').classList.toggle('!border-gray-200', shouldDisable && !isFull);
            });
        }
        
        submitCraftsBooking() {
            if (!this.state.registrationData) {
                this.showModal('æŠ¥åé™åˆ¶', 'è¯·æ‚¨å…ˆå®Œæˆå®¶åº­æ—¥ä¸»æ´»åŠ¨æŠ¥åï¼Œæ‰èƒ½é¢„çº¦æ‰‹ä½œå·¥åŠå“¦ï¼');
                return;
            }

            // SIMULATION: In a real app, this would be a transaction.
            // For now, we just add the user's final selection to the global pool.
            this.state.craftsBookingData.forEach(booking => {
                // To avoid duplicates if user re-submits, check first. A real backend would handle this.
                if (!this.state.allCraftsBookings.some(b => b.user === this.state.currentUser.id && b.id === booking.id)) {
                     this.state.allCraftsBookings.push({...booking, user: this.state.currentUser.id });
                }
            });
            this.saveState();

            const successInfoEl = this.getEl('c-success-info');
            if(this.state.craftsBookingData.length > 0){
                successInfoEl.innerHTML = this.state.craftsBookingData.map(b => `<p><strong>${b.title}:</strong> ${b.session}</p>`).join('');
            } else {
                 successInfoEl.innerHTML = `<p>æ‚¨æœ¬æ¬¡æœªé¢„çº¦ä»»ä½•é¡¹ç›®ã€‚</p>`;
            }
            this.showPage('craftsSuccessPage');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new H5App('app-container');
    });
</script>
</body>
</html>

