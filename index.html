<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>礼来家庭日</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --lilly-red: #E1251B;
            --lilly-pink: #FBCFC8;
            --lilly-black: #212121;
            --lilly-green-light: #e0f2f1;
            --lilly-green-dark: #00796b;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Helvetica', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
            background-color: #f3f4f6;
        }
        #app-container {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative; 
            background-color: white;
        }
        #app-container::-webkit-scrollbar {
            display: none;  
        }
        .font-ringside {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s;
            min-height: 100%;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
            background-color: #f9fafb;
        }
        .page-content {
            flex-grow: 1;
            padding: 1.5rem;
        }
        .sticky-footer {
            position: sticky;
            bottom: 0;
            background-color: white;
            padding: 0.75rem 1.5rem 1.5rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            z-index: 10;
        }
        .lilly-button {
            background-color: var(--lilly-red);
            color: white;
        }
        .lilly-button:hover {
             opacity: 0.9;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .custom-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(4px);
        }
        .custom-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .custom-modal-content {
            background: white;
            border-radius: 1rem;
            width: 90%;
            max-width: 520px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            display: flex;
            padding: 0;
            overflow: hidden;
            flex-direction: column;
        }
         @media (min-width: 640px) {
            .custom-modal-content {
                max-width: 780px;
            }
        }
        .custom-modal-overlay.visible .custom-modal-content {
             transform: scale(1);
        }
        .modal-image-container {
             width: 100%;
             height: 150px;
             flex-shrink: 0;
        }
        @media (min-width: 640px) {
             .modal-image-container {
                width: 45%;
                height: auto;
             }
        }
        .modal-text-container {
            width: 100%;
            padding: 1.5rem;
            text-align: left;
            display: flex;
            flex-direction: column;
        }
         @media (min-width: 640px) {
            .modal-text-container {
                width: 55%;
                padding: 2rem;
            }
         }
        .custom-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 1rem;
        }
        .custom-modal-text {
            color: #555;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            flex-grow: 1;
        }
        @keyframes pulse-scale {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        .map-hotspot {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            animation: pulse-scale 2.5s infinite ease-in-out;
            transition: transform 0.2s;
        }
        .map-hotspot:hover {
            transform: scale(1.15);
        }
        .map-icon {
            width: 40px;
            height: 40px;
            background-color: rgba(251, 191, 36, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 2px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .map-label {
            margin-top: 4px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .scratch-container {
            position: relative;
            width: 100%;
            cursor: crosshair;
            border-radius: 0.75rem;
            overflow: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .scratch-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
        
        /* Craft & Badminton Card Styles */
        .event-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }
        .event-card-header {
            padding: 1rem 1rem 0.5rem;
        }
        .event-card-body {
            padding: 0 1rem 1rem;
        }
        .session-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 0.5rem;
        }
        /* New Scratch Reveal Styles */
        .themed-activity-card {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            border-radius: 0.75rem;
            padding: 0.75rem;
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 220px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .themed-activity-card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .themed-activity-card img {
             width: 48px;
             height: 48px;
             border-radius: 0.5rem;
             object-fit: cover;
             flex-shrink: 0;
        }
        .themed-activity-card h4 {
            font-weight: 700;
            font-size: 0.9rem;
            color: #1f2937;
        }
        .themed-activity-card p {
             font-size: 0.75rem;
             color: #4b5563;
        }
    </style>
</head>
<body>
    <!-- 主应用容器 -->
    <div id="app-container">
    </div>
    
    <!-- 全局通用模态框 -->
    <div id="customModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <div class="modal-image-container">
                <img data-id="modalImage" src="" class="w-full h-full object-cover">
            </div>
            <div class="modal-text-container">
                <h3 data-id="modalTitle" class="custom-modal-title font-ringside">提示</h3>
                <p data-id="modalText" class="custom-modal-text">这是一个提示信息。</p>
                <button data-id="modalCloseBtn" class="w-full lilly-button font-bold py-3 px-4 rounded-lg mt-auto">关闭</button>
            </div>
        </div>
    </div>

    <!-- 探索之旅模态框 -->
    <div id="exploreModal" class="custom-modal-overlay">
         <div class="custom-modal-content !p-6 !max-w-md !flex-col">
            <h3 class="custom-modal-title font-ringside">开启你的奇遇之旅！</h3>
            <p class="custom-modal-text">三大主题世界，乐趣各不相同。选择一个，亲手揭开它的神秘面纱吧！</p>
            <div class="space-y-3 mt-4 w-full">
                <div data-action="showScratchPage" data-type="fun" class="p-4 bg-gradient-to-br from-yellow-200 to-amber-300 rounded-xl cursor-pointer text-left hover:shadow-lg transition-shadow">
                    <h4 class="font-bold text-lg text-amber-800 font-ringside">「趣」· 奇想世界</h4>
                    <p class="text-sm text-amber-700 mt-1">亲近自然，放飞童心！</p>
                </div>
                <div data-action="showScratchPage" data-type="win" class="p-4 bg-gradient-to-br from-red-200 to-rose-300 rounded-xl cursor-pointer text-left hover:shadow-lg transition-shadow">
                    <h4 class="font-bold text-lg text-rose-800 font-ringside">「赢」· 卡路里战场</h4>
                    <p class="text-sm text-rose-700 mt-1">团队集结，为荣誉而战！</p>
                </div>
                <div data-action="showScratchPage" data-type="diy" class="p-4 bg-gradient-to-br from-purple-200 to-violet-300 rounded-xl cursor-pointer text-left hover:shadow-lg transition-shadow">
                    <h4 class="font-bold text-lg text-violet-800 font-ringside">「作」· 慢时光工坊</h4>
                    <p class="text-sm text-violet-700 mt-1">静下心，与家人共创温馨。</p>
                </div>
            </div>
            <button data-action="closeExploreModal" class="w-full mt-6 bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg">返回地图</button>
        </div>
    </div>
    
    <!-- 核销确认模态框 -->
    <div id="verificationModal" class="custom-modal-overlay">
        <div class="custom-modal-content !p-6 !max-w-sm !flex-col text-center">
            <h3 data-id="verificationModalTitle" class="custom-modal-title font-ringside">确认核销</h3>
            <p data-id="verificationModalText" class="custom-modal-text">请注意，此操作不可撤销。</p>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <button data-action="closeVerificationModal" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg">取消</button>
                <button data-action="confirmVerification" class="w-full lilly-button font-bold py-3 px-4 rounded-lg">确认</button>
            </div>
        </div>
    </div>


<!-- 页面模板 -->
<template id="app-template">
    <!-- 开屏页 -->
    <div id="splashPage" class="page flex flex-col justify-end items-center text-center p-8 bg-cover bg-center" style="background-image: url('https://raw.githubusercontent.com/gaoshijun1983-collab/Lilly-H5/main/1.1%20%E5%BC%80%E5%B1%8F%E9%A1%B5%E4%B8%BB%E8%A7%86%E8%A7%89%EF%BC%881179%C3%972556%EF%BC%89.png'); height: 100%;">
        <button data-action="showPage" data-page="verificationPage" class="w-full max-w-xs bg-white text-red-600 font-bold py-4 px-4 rounded-full shadow-2xl transition-transform transform hover:scale-105 animate-pulse mb-12 font-ringside">
             开启家庭日之旅
        </button>
    </div>

    <!-- 员工验证页 -->
    <div id="verificationPage" class="page flex items-center justify-center p-6 bg-gray-50">
        <div class="bg-white rounded-2xl p-8 shadow-xl text-center w-full max-w-sm">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 font-ringside" style="color: var(--lilly-red);">员工身份验证</h2>
            <p class="text-gray-600 mb-6">请输入您的信息以继续</p>
            <div class="space-y-4">
                <input data-id="employeeIdInput" type="text" placeholder="员工号" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition" value="Lilly001">
                <input data-id="employeeNameInput" type="text" placeholder="姓名" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition" value="张伟">
                <input data-id="employeePhoneInput" type="tel" placeholder="电话" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition" value="13800138000">
            </div>
            <p data-id="verificationError" class="text-red-500 text-sm mt-2 h-5"></p>
            <button data-action="verifyEmployee" class="w-full lilly-button font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-transform transform hover:scale-105 mt-4">
                验证进入
            </button>
        </div>
    </div>
    
    <!-- 地图页 -->
    <div id="mapPage" class="page">
        <div class="page-content !p-0">
            <div class="relative w-full">
                <img src="https://raw.githubusercontent.com/gaoshijun1983-collab/Lilly-H5/main/Untitled-20250903-140555-6842-4x.jpg" class="w-full h-auto">
                <div data-action="showPage" data-page="badmintonIntroPage" class="map-hotspot" style="top: 52%; left: 35%;"><div class="map-icon bg-red-500">🏸</div><div class="map-label">羽毛球大赛</div></div>
                <div data-action="showHighlight" data-highlight="event" class="map-hotspot" style="top: 68%; left: 60%;"><div class="map-icon">💥</div><div class="map-label">尖叫搏击赛</div></div>
                <div data-action="showPage" data-page="craftsBookingPage" class="map-hotspot" style="top: 22%; left: 30%;"><div class="map-icon bg-purple-500">🎨</div><div class="map-label">慢时光工坊</div></div>
                <div data-action="showHighlight" data-highlight="offroad" class="map-hotspot" style="top: 35%; left: 75%;"><div class="map-icon">🚙</div><div class="map-label">越野车</div></div>
                <div data-action="showHighlight" data-highlight="picking" class="map-hotspot" style="top: 55%; left: 80%;"><div class="map-icon">🧺</div><div class="map-label">野餐区</div></div>
                <div data-action="showHighlight" data-highlight="party" class="map-hotspot" style="top: 80%; left: 78%;"><div class="map-icon">🔥</div><div class="map-label">篝火派对</div></div>
                <div data-action="showHighlight" data-highlight="fireworks" class="map-hotspot" style="top: 85%; left: 55%;"><div class="map-icon">🎆</div><div class="map-label">烟花秀</div></div>
            </div>
            <div class="p-4">
                <div class="p-4 bg-red-50 border-l-4 border-red-400 text-red-800 rounded-r-lg">
                    <h3 class="font-bold font-ringside text-lilly-red">从午后到星辰，快乐不落幕</h3>
                    <p class="text-sm mt-1">今年狂欢延长至夜晚！体验白日活力，享受星空下的派对与烟花！</p>
                </div>
                 <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-6 text-center">
                    <div data-action="showPage" data-page="registrationPage" class="flex flex-col items-center justify-center p-4 bg-white rounded-2xl shadow-sm cursor-pointer hover:shadow-md transition">
                        <div class="w-12 h-12 flex items-center justify-center bg-blue-100 text-blue-600 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></div>
                        <span class="mt-2 font-semibold text-sm">报名入口</span>
                    </div>
                    <div data-action="openExploreModal" class="flex flex-col items-center justify-center p-4 bg-white rounded-2xl shadow-sm cursor-pointer hover:shadow-md transition">
                        <div class="w-12 h-12 flex items-center justify-center bg-amber-100 text-amber-600 rounded-full"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                        <span class="mt-2 font-semibold text-sm">探索奇遇</span>
                    </div>
                    <div data-action="showPhotoAlbum" class="flex flex-col items-center justify-center p-4 bg-white rounded-2xl shadow-sm cursor-pointer hover:shadow-md transition">
                       <div class="w-12 h-12 flex items-center justify-center bg-green-100 text-green-600 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div>
                        <span class="mt-2 font-semibold text-sm">精彩瞬间</span>
                    </div>
                    <div data-action="showMyBookings" class="flex flex-col items-center justify-center p-4 bg-white rounded-2xl shadow-sm cursor-pointer hover:shadow-md transition">
                        <div class="w-12 h-12 flex items-center justify-center bg-purple-100 text-purple-600 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path></svg></div>
                        <span class="mt-2 font-semibold text-sm">我的凭证</span>
                    </div>
                 </div>
            </div>
        </div>
    </div>

    <!-- 刮刮卡页 -->
    <div id="scratchPage" class="page">
        <div class="page-content">
            <h2 data-id="scratchTitle" class="text-3xl font-bold mb-2 font-ringside"></h2>
            <p class="text-gray-600 mb-4">擦亮这片区域，看看藏着哪些奇妙乐趣！</p>
            
            <div data-id="scratchContainer" class="scratch-container">
                <canvas data-id="scratchCanvas" class="scratch-canvas"></canvas>
                <div data-id="scratchContent" class="rounded-lg">
                    <div data-id="activityListContainer" class="space-y-4">
                    </div>
                </div>
            </div>
        </div>
         <div class="sticky-footer">
            <button data-action="closeScratchPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">返回探索之旅</button>
        </div>
    </div>
    
    <!-- 家庭日报名页 -->
    <div id="registrationPage" class="page">
         <div class="page-content">
            <h2 class="text-3xl font-bold mb-6 font-ringside" style="color: var(--lilly-red);">活动报名</h2>
            <div class="space-y-6">
                <div>
                    <label class="font-semibold text-gray-700">员工信息 (您本人)</label>
                    <div class="mt-2 p-4 bg-gray-100 rounded-lg">
                        <p><strong>工号:</strong> <span data-id="regEmployeeId"></span></p>
                        <p><strong>姓名:</strong> <span data-id="regEmployeeName"></span></p>
                        <p><strong>电话:</strong> <span data-id="regEmployeePhone"></span></p>
                    </div>
                </div>
                <div>
                    <label class="font-semibold text-gray-700">家属信息 (如无家属同行，此项可不填)</label>
                    <div class="mt-2 p-4 border rounded-lg space-y-4">
                        <div data-id="familyFormsContainer" class="space-y-3"></div>
                        <button data-action="addFamilyMemberForm" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition text-sm">
                            + 添加家属
                        </button>
                    </div>
                </div>
                <div>
                    <label class="font-semibold text-gray-700">用餐安排 (三批次分流)</label>
                    <div class="space-y-2 mt-2">
                        <label class="flex items-center p-4 border rounded-lg has-[:checked]:bg-red-50 has-[:checked]:border-red-400 cursor-pointer">
                            <input type="radio" name="dining" value="17:00 - 17:40 (红票)" class="h-5 w-5" style="accent-color: var(--lilly-red);">
                            <span class="ml-3"><strong>批次一 (红票):</strong> 17:00 - 17:40</span>
                        </label>
                        <label class="flex items-center p-4 border rounded-lg has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                            <input type="radio" name="dining" value="17:40 - 18:20 (蓝票)" class="h-5 w-5" checked>
                            <span class="ml-3"><strong>批次二 (蓝票):</strong> 17:40 - 18:20</span>
                        </label>
                        <label class="flex items-center p-4 border rounded-lg has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-400 cursor-pointer">
                            <input type="radio" name="dining" value="18:20 - 19:00 (黄票)" class="h-5 w-5">
                            <span class="ml-3"><strong>批次三 (黄票):</strong> 18:20 - 19:00</span>
                        </label>
                    </div>
                </div>
                 <div>
                    <label class="font-semibold text-gray-700">出行方式</label>
                    <div class="flex gap-4 mt-2">
                         <label class="flex-1 flex items-center p-4 border rounded-lg has-[:checked]:bg-green-50 has-[:checked]:border-green-400 cursor-pointer">
                            <input type="radio" name="transport" value="公司大巴" class="h-5 w-5 text-green-600">
                            <span class="ml-3">公司大巴</span>
                        </label>
                         <label class="flex-1 flex items-center p-4 border rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-400 cursor-pointer">
                            <input type="radio" name="transport" value="自行前往" class="h-5 w-5 text-indigo-600" checked>
                            <span class="ml-3">自行前往</span>
                        </label>
                    </div>
                    <div data-id="transportDetails" class="mt-4 hidden p-4 bg-green-50 border border-green-200 rounded-lg">
                        <p class="font-semibold text-green-800">班车信息</p>
                        <p class="text-sm text-green-700 mt-1">具体班车路线和时间安排，将由HR在活动前统一通知，请留意后续邮件。
                    </div>
                </div>
                <button data-action="submitRegistration" class="w-full mt-8 lilly-button font-bold py-4 px-4 rounded-lg hover:opacity-90 transition-transform transform hover:scale-105">
                    确认信息，生成我的出发券
                </button>
            </div>
        </div>
         <div class="sticky-footer">
            <button data-action="showPage" data-page="mapPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">
                返回地图首页
            </button>
        </div>
    </div>
    
    <!-- 报名成功/我的凭证页 -->
    <div id="successPage" class="page">
        <div class="page-content flex flex-col items-center">
            <h2 class="text-3xl font-bold font-ringside text-center" style="color: var(--lilly-red);">我的凭证</h2>
            <div class="bg-white p-4 rounded-lg shadow-md w-full max-w-sm mt-6 text-center">
                 <img data-id="qrCode" src="https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=LillyFamilyDay-Default" alt="模拟签到二维码" class="w-48 h-48 rounded-md mx-auto">
                 <p class="mt-4 font-semibold text-lg" data-id="successName"></p>
                 <p class="text-sm text-gray-500" data-id="successId"></p>
            </div>
            <div data-id="allMyBookings" class="mt-6 w-full max-w-sm space-y-4">
            </div>
        </div>
         <div class="sticky-footer">
              <button data-action="showPage" data-page="mapPage" class="w-full p-4 lilly-button rounded-xl text-center hover:opacity-90 transition font-semibold">
                返回地图首页
            </button>
        </div>
    </div>

    <!-- 活动详情页 -->
    <div id="itemDetailPage" class="page">
        <div class="page-content">
            <img data-id="itemDetailImage" src="" class="w-full h-48 object-cover rounded-lg mb-4 shadow-md">
            <h2 data-id="itemDetailTitle" class="text-3xl font-bold mb-4 font-ringside"></h2>
            <p data-id="itemDetailDescription" class="text-gray-600 leading-relaxed"></p>
            <div class="mt-6 bg-gray-100 p-4 rounded-lg">
                <h3 class="font-bold text-lg text-gray-800 mb-2">规则趣解</h3>
                <p data-id="itemDetailRules" class="text-gray-600 text-sm"></p>
            </div>
        </div>
        <div class="sticky-footer">
            <button data-id="itemDetailBackButton" data-action="returnToScratchPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">返回列表</button>
        </div>
    </div>
    
    <!-- 羽毛球大赛介绍页 -->
    <div id="badmintonIntroPage" class="page">
        <div class="page-content !p-0 sm:!p-6">
             <div class="relative">
                <img src="https://images.unsplash.com/photo-1518291361833-53e33c7f1a3a?q=80&w=2574&auto=format&fit=crop" class="w-full h-40 sm:h-56 object-cover sm:rounded-2xl">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent sm:rounded-2xl"></div>
                <div class="absolute bottom-0 left-0 p-4 sm:p-6">
                    <h2 class="text-3xl font-bold font-ringside text-white">「谁羽争锋」大赛</h2>
                    <p class="text-white/90 mt-1 text-sm">热血集结，挥拍点燃赛场！</p>
                </div>
            </div>
            <div class="p-4 sm:p-0 mt-4 space-y-4">
                <div data-action="showBadmintonRegPage" data-page="badmintonRegisterPage_mens" class="event-card flex items-center justify-between p-4 cursor-pointer hover:shadow-xl transition-shadow bg-gradient-to-r from-blue-50 to-white">
                    <div>
                        <h4 class="font-bold text-blue-800 font-ringside text-lg">男子单打</h4>
                        <p class="text-sm text-blue-700 mt-1">英雄集结，一战封王</p>
                    </div>
                    <div class="text-right text-sm flex-shrink-0 ml-4">
                        <p class="font-semibold text-blue-800">已报名: <span data-id="mens_count">0</span></p>
                        <p class="text-xs text-blue-600 mt-1">剩余: <span data-id="mens_remain">16</span></p>
                    </div>
                </div>
                <div data-action="showBadmintonRegPage" data-page="badmintonRegisterPage_womens" class="event-card flex items-center justify-between p-4 cursor-pointer hover:shadow-xl transition-shadow bg-gradient-to-r from-pink-50 to-white">
                    <div>
                        <h4 class="font-bold text-pink-800 font-ringside text-lg">女子单打</h4>
                        <p class="text-sm text-pink-700 mt-1">铿锵玫瑰，赛场绽放</p>
                    </div>
                    <div class="text-right text-sm flex-shrink-0 ml-4">
                        <p class="font-semibold text-pink-800">已报名: <span data-id="womens_count">0</span></p>
                        <p class="text-xs text-pink-600 mt-1">剩余: <span data-id="womens_remain">16</span></p>
                    </div>
                </div>
                <div data-action="showBadmintonRegPage" data-page="badmintonRegisterPage_mixed" class="event-card flex items-center justify-between p-4 cursor-pointer hover:shadow-xl transition-shadow bg-gradient-to-r from-purple-50 to-white">
                     <div>
                        <h4 class="font-bold text-purple-800 font-ringside text-lg">混合双打</h4>
                        <p class="text-sm text-purple-700 mt-1">最佳拍档，默契致胜</p>
                    </div>
                    <div class="text-right text-sm flex-shrink-0 ml-4">
                        <p class="font-semibold text-purple-800">已报名: <span data-id="mixed_count">0</span></p>
                        <p class="text-xs text-purple-600 mt-1">剩余: <span data-id="mixed_remain">16</span></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="sticky-footer">
            <button data-action="showPage" data-page="mapPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">返回地图首页</button>
        </div>
    </div>

    <!-- 羽毛球报名页 -->
    <div id="badmintonRegisterPage_mens" class="page badminton-reg-page">
        <div class="page-content"><h2 class="text-3xl font-bold mb-6 font-ringside" style="color: var(--lilly-red);">男子单打报名</h2><form class="space-y-4" data-type="mens"><p class="text-sm text-gray-600">请填写您的参赛信息。</p><input type="text" placeholder="姓名" name="name1" class="w-full px-4 py-3 border-2 rounded-lg" required><input type="tel" placeholder="电话" name="phone1" class="w-full px-4 py-3 border-2 rounded-lg" required><button type="submit" class="w-full mt-4 lilly-button font-bold py-3 rounded-lg hover:opacity-90">确认报名</button></form></div>
        <div class="sticky-footer"><button data-action="showPage" data-page="badmintonIntroPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">返回大赛介绍</button></div>
    </div>
    <div id="badmintonRegisterPage_womens" class="page badminton-reg-page">
        <div class="page-content"><h2 class="text-3xl font-bold mb-6 font-ringside" style="color: var(--lilly-red);">女子单打报名</h2><form class="space-y-4" data-type="womens"><p class="text-sm text-gray-600">请填写您的参赛信息。</p><input type="text" placeholder="姓名" name="name1" class="w-full px-4 py-3 border-2 rounded-lg" required><input type="tel" placeholder="电话" name="phone1" class="w-full px-4 py-3 border-2 rounded-lg" required><button type="submit" class="w-full mt-4 lilly-button font-bold py-3 rounded-lg hover:opacity-90" style="background-color: #ec4899;">确认报名</button></form></div>
        <div class="sticky-footer"><button data-action="showPage" data-page="badmintonIntroPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">返回大赛介绍</button></div>
    </div>
    <div id="badmintonRegisterPage_mixed" class="page badminton-reg-page">
        <div class="page-content"><h2 class="text-3xl font-bold mb-6 font-ringside" style="color: var(--lilly-red);">混合双打报名</h2><form class="space-y-6" data-type="mixed"><div><label class="font-semibold text-gray-700">队员一信息</label><div class="space-y-3 mt-2 p-4 border rounded-lg"><input type="text" placeholder="姓名" name="name1" class="w-full px-4 py-3 border-2 rounded-lg" required><input type="tel" placeholder="电话" name="phone1" class="w-full px-4 py-3 border-2 rounded-lg" required><select class="w-full px-4 py-3 border-2 rounded-lg bg-white" name="gender1" required><option value="" disabled selected>性别</option><option>男</option><option>女</option></select></div></div><div><label class="font-semibold text-gray-700">队员二信息 (您的搭档)</label><div class="space-y-3 mt-2 p-4 border rounded-lg"><input type="text" placeholder="姓名" name="name2" class="w-full px-4 py-3 border-2 rounded-lg" required><input type="tel" placeholder="电话" name="phone2" class="w-full px-4 py-3 border-2 rounded-lg" required><select class="w-full px-4 py-3 border-2 rounded-lg bg-white" name="gender2" required><option value="" disabled selected>性别</option><option>男</option><option>女</option></select></div></div><button type="submit" class="w-full mt-4 lilly-button font-bold py-3 rounded-lg hover:opacity-90" style="background-color: #a855f7;">确认报名</button></form></div>
        <div class="sticky-footer"><button data-action="showPage" data-page="badmintonIntroPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">返回大赛介绍</button></div>
    </div>
    
    <!-- 羽毛球报名成功页 -->
    <div id="badmintonSuccessPage" class="page">
        <div class="page-content text-center flex flex-col items-center justify-center">
             <div class="w-24 h-24 rounded-full flex items-center justify-center mb-6 mx-auto" style="background-color: var(--lilly-green-light);"><svg class="w-16 h-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
            <h2 class="text-3xl font-bold font-ringside" style="color: var(--lilly-red);">大赛报名成功!</h2>
            <p class="text-gray-600 mt-2 mb-8">比赛信息已记录，现场凭姓名签到。</p>
            <div data-id="b-success-info" class="text-left w-full max-w-xs bg-gray-50 p-4 rounded-lg"></div>
        </div>
        <div class="sticky-footer space-y-2">
            <button data-action="showPage" data-page="badmintonIntroPage" class="w-full p-4 lilly-button rounded-xl text-center hover:opacity-90 transition font-semibold">返回大赛介绍</button>
            <button data-action="showMyBookings" class="w-full p-4 bg-gray-200 text-gray-800 rounded-xl text-center hover:bg-gray-300 transition font-semibold">查看我的所有报名</button>
        </div>
    </div>

    <!-- 手作工坊预约页 -->
    <div id="craftsBookingPage" class="page">
        <div class="page-content !p-0 sm:!p-6">
            <div class="relative">
                <img src="https://images.unsplash.com/photo-1513364776144-60967b0f800f?q=80&w=1200&auto=format&fit=crop" class="w-full h-40 sm:h-56 object-cover sm:rounded-2xl">
                <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent sm:rounded-2xl"></div>
                <div class="absolute bottom-0 left-0 p-4 sm:p-6">
                    <h2 class="text-3xl font-bold font-ringside text-white">手作工坊预约</h2>
                    <p class="text-white/90 mt-1 text-sm">与家人一起，创造独一无二的温馨回忆</p>
                </div>
            </div>
            
            <div class="p-4 sm:p-0">
                <div class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 rounded-r-lg" data-id="craftsNotice">
                    <h3 class="font-bold">报名须知</h3>
                    <ul class="list-disc list-inside text-sm mt-2 space-y-1">
                        <li>每个家庭总共可在线预约 <b>2</b> 个手作项目 (50%名额)。</li>
                        <li>其中，<b>老师指导课</b> 由于名额有限，每个家庭最多只能选择 <b>1</b> 项。</li>
                        <li class="font-bold">请准时到场！预约课程开始前5分钟仍未到场，名额将自动释放给现场等候的家庭哦！</li>
                    </ul>
                </div>
                <div data-id="craftsListContainer" class="mt-6 space-y-4">
                    <!-- JS will populate this -->
                </div>
            </div>
        </div>
        <div class="sticky-footer grid grid-cols-2 gap-4">
            <button data-action="showPage" data-page="mapPage" class="w-full p-4 bg-gray-200 text-gray-700 rounded-xl text-center hover:bg-gray-300 transition font-semibold">返回地图</button>
            <button data-action="submitCraftsBooking" class="w-full p-4 lilly-button rounded-xl text-center hover:opacity-90 transition font-semibold">确认我的预约</button>
        </div>
    </div>

    <!-- 手作预约成功页 -->
    <div id="craftsSuccessPage" class="page">
        <div class="page-content text-center flex flex-col items-center justify-center">
             <div class="w-24 h-24 rounded-full flex items-center justify-center mb-6 mx-auto" style="background-color: var(--lilly-green-light);"><svg class="w-16 h-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
            <h2 class="text-3xl font-bold font-ringside" style="color: var(--lilly-red);">手作预约成功!</h2>
            <p class="text-gray-600 mt-2 mb-8">请在预约时间前5分钟，凭“我的凭证”到场签到。</p>
            <div data-id="c-success-info" class="text-left w-full max-w-sm bg-gray-50 p-4 rounded-lg"></div>
        </div>
        <div class="sticky-footer space-y-2">
            <button data-action="showPage" data-page="mapPage" class="w-full p-4 lilly-button rounded-xl text-center hover:opacity-90 transition font-semibold">返回地图首页</button>
            <button data-action="showMyBookings" class="w-full p-4 bg-gray-200 text-gray-800 rounded-xl text-center hover:bg-gray-300 transition font-semibold">查看我的所有凭证</button>
        </div>
    </div>
</template>

<script>
    // 静态数据
    const HIGHLIGHT_DATA = {
        event: { title: "百人开团，尖叫搏击！", text: "忘掉拘束，释放天性！巨型道具和趣味规则，让每个人都能瞬间融入，引爆团队协作的无限能量！", img: "https://images.unsplash.com/photo-1593341641692-aa7a8a7f711b?q=80&w=2574&auto=format&fit=crop" },
        offroad: { title: "引擎轰鸣，尘土飞扬！", text: "想体验一把现实版的“速度与激情”吗？握紧方向盘，穿越崎岖赛道，体验肾上腺素飙升的极致快感！", img: "https://images.unsplash.com/photo-1610479593531-c5d9a_b3b3f8?q=80&w=2574&auto=format&fit=crop" },
        party: { title: "夜幕降临，压轴大戏！", text: "当篝火点燃，音乐响起，一场献给所有家庭的草坪派对正式开始。尽情舞动，享受此刻的惬意与自由！", img: "https://images.unsplash.com/photo-1588124239333-594a73f403e3?q=80&w=2574&auto=format&fit=crop" },
        fireworks: { title: "点亮夜空，定格璀璨！", text: "一场献给所有家庭的璀璨烟花秀，将为今天画上最亮的感叹号！抬头仰望，将这份美好永远珍藏。", img: "https://images.unsplash.com/photo-1533294262438-2895680215a2?q=80&w=2574&auto=format&fit=crop" },
        picking: { title: "奔跑吧，都市农夫！", text: "集结！根据神秘任务卡，冲向田野，寻找最新鲜的战利品。速度最快的队伍，将赢得丰收的荣耀！", img: "https://images.unsplash.com/photo-1567357504313-264259336946?q=80&w=2574&auto=format&fit=crop" }
    };

    const ACTIVITY_DATA = {
        fun: {
            title: "「趣」· 奇想世界",
            items: [
                { id: 'fun-1', title: '雀神争霸赛', subtitle: '巨型麻将，全家开杠', desc: '超超超大号的麻将，见过没？来这里，你就是牌桌上的巨人！全家上阵，体验一把“杠上开花”的霸气，看看谁才是真正的雀神本神！', img: 'https://images.unsplash.com/photo-1591640242546-0b0b8c6c8e3f?q=80&w=2574&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1591640242546-0b0b8c6c8e3f?q=80&w=128&h=128&fit=crop', rules: '4人一组，欢乐开局！规则和普通麻将一样简单，但快乐是PLUS版的！注意哦，推倒牌堆可是要接受全家人的“嘲笑”惩罚的！' },
                { id: 'fun-2', title: '疯狂卡丁车', subtitle: '体验速度的快感', desc: '系好安全带，踩下油门，把烦恼远远甩在身后！这里没有红绿灯，只有心跳和尖叫！快来和家人一起，上演一场现实版的《速度与激情》！', img: 'https://images.unsplash.com/photo-1559137326-b8e7b1a8d1a5?q=80&w=2574&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1559137326-b8e7b1a8d1a5?q=80&w=128&h=128&fit=crop', rules: '安全第一，比赛第二！戴上头盔，你就是最靓的仔！在专属赛道里尽情驰骋，用漂亮的漂移征服每一个弯道吧！' },
                { id: 'fun-3', title: '田园小火车', subtitle: '悠闲观光之旅', desc: '呜~呜~开往春天的童话列车即将发车！带上爸爸妈妈，穿过绿色的田野，路过可爱的稻草人，享受一段被阳光和微风包裹的悠闲时光。', img: 'https://images.unsplash.com/photo-1533235898686-21f45f229ac5?q=80&w=2535&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1533235898686-21f45f229ac5?q=80&w=128&h=128&fit=crop', rules: '请有序排队上车，坐稳扶好。小火车会带你环游整个农场，记得向窗外的小动物们挥手问好呀！' },
                { id: 'fun-4', title: '水上碰碰船', subtitle: '夏日清凉大作战', desc: '夏日炎炎，玩水才是正经事！驾驶你的专属座驾，在水面上演一场“碰”然心动的追逐战，撞走所有不开心，收获一整天的清凉！', img: 'https://images.unsplash.com/photo-1534056220515-b2b35541105e?q=80&w=2574&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1534056220515-b2b35541105e?q=80&w=128&h=128&fit=crop', rules: '穿好救生衣，你就是这条“河”最野的崽！我们的目标是：友好地“攻击”对方的船只，比比谁的水上漂移技术更胜一筹！' },
            ]
        },
        win: {
            title: "「赢」· 卡路里战场",
            items: [
                { id: 'win-1', title: '进击的跳远', subtitle: '运气与勇气的对决', desc: '这不是普通的跳远，这是一场勇气、智慧和运气的终极对决！在不断延伸的赛道上，你和对手狭路相逢，猜拳决定谁是王者！', img: 'https://images.unsplash.com/photo-1571008781613-581373c09930?q=80&w=2574&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1571008781613-581373c09930?q=80&w=128&h=128&fit=crop', rules: '石头剪刀布，一决胜负！跳到对手面前，赢家继续前进，输家……换队友从头再来！先占领对方大本营的队伍，就是最终的冠军！' },
                { id: 'win-2', title: '巨型排球对抗赛', subtitle: '超乎想象的团队乐趣', desc: '比你想象中还大的巨型排球来啦！这考验的不是球技，是团队的心跳同步率！每一次托举，每一次传递，都是我们默契的证明。得分瞬间，燃爆全场！', img: 'https://images.unsplash.com/photo-1612872087720-bb876e2e67d1?q=80&w=2574&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1612872087720-bb876e2e67d1?q=80&w=128&h=128&fit=crop', rules: '团结就是力量！全队齐心协力，把这个“庞然大物”拍过网，落地就算得分！温馨提示：小心被球砸到哦，它真的很大！' },
            ]
        },
        diy: {
            title: "「作」· 慢时光工坊",
            items: [
                 { id: 'diy-1', title: '扭扭棒DIY', category: 'A', subtitle: '化身妙趣手工“花”匠', desc: '谁说鲜花只能去花店买？在这里，几根毛茸茸的扭扭棒，就能在你手中绽放出永不凋谢的“花”与“匠心”。快来化身手工魔法师，创造你的专属花束吧！', img: 'https://images.unsplash.com/photo-1678822369408-e3a88a882a9d?q=80&w=1200&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1678822369408-e3a88a882a9d?q=80&w=128&h=128&fit=crop', rules: '领取你的“魔法棒”（扭扭棒材料包），跟着感觉走！你可以自由创作，也可以参考我们的灵感图册。遇到困难？随时呼叫我们的指导小老师哦！', duration: 40, capacity: 15, onlineTotal: 22, sessions: ['15:45-16:25', '16:30-17:10', '17:15-17:55']},
                 { id: 'diy-2', title: '沙画/填绘DIY', category: 'A', subtitle: '用色彩描绘童真', desc: '用五彩斑斓的沙子，描绘心中的童话世界。一层一层，一笔一画，将想象力与专注力融合，创作一幅独一无二、可以带回家的精美沙画艺术品。', img: 'https://images.unsplash.com/photo-1599408285942-03f194723438?q=80&w=1200&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1599408285942-03f194723438?q=80&w=128&h=128&fit=crop', rules: '选择你心仪的画板，然后大胆地玩弄色彩吧！先撕掉哪块不干胶，就先撒上哪种颜色的沙子，轻轻一抖，惊喜就出现啦！', duration: 40, capacity: 15, onlineTotal: 22, sessions: ['15:45-16:25', '16:30-17:10', '17:15-17:55']},
                 { id: 'diy-3', title: '掐丝珐琅DIY', category: 'B', subtitle: '封存此刻的美好', desc: '体验一次穿越千年的宫廷技艺！用金色的丝线勾勒轮廓，再填入绚烂的珐琅彩，亲手封存一份古典与现代交织的美好。成品绝对惊艳你的朋友圈！', img: 'https://images.unsplash.com/photo-1629910229818-f25b4b3a6288?q=80&w=1200&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1629910229818-f25b4b3a6288?q=80&w=128&h=128&fit=crop', rules: '第一步，用巧劲儿将铜丝“掐”出你喜欢的图案。第二步，像填色游戏一样，用滴管把彩砂填入空白处。最后一步，也是最重要的一步：拍照留念！', duration: 30, capacity: 14, onlineTotal: 28, sessions: ['15:45-16:15', '16:20-16:50', '16:55-17:25', '17:30-18:00']},
                 { id: 'diy-4', title: '手绘风铃DIY', category: 'B', subtitle: '亲手绘制夏日之声', desc: '夏天是什么声音？是冰西瓜的甜，也是风铃的脆。拿起画笔，在清透的玻璃风铃上，画下属于你的夏日密语，让每一次清风拂过，都为你奏响专属的旋律。', img: 'https://images.unsplash.com/photo-1596791694931-e6a88b201584?q=80&w=1200&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1596791694931-e6a88b201584?q=80&w=128&h=128&fit=crop', rules: '大胆发挥你的艺术细胞！用特制的颜料在玻璃风铃上尽情创作。画完后记得要让它自然风干，才能把这份“夏天的声音”完好无损地带回家哦。', duration: 30, capacity: 14, onlineTotal: 28, sessions: ['15:45-16:15', '16:20-16:50', '16:55-17:25', '17:30-18:00']},
                 { id: 'diy-5', title: '马赛克灯DIY', category: 'B', subtitle: '点亮异域风情', desc: '一秒穿越到土耳其！亲手拼贴五彩的琉璃片，在光影交错间，点亮一盏充满异域风情的马赛克灯。当灯光亮起，整个房间都将变得温柔又浪漫。', img: 'https://images.unsplash.com/photo-1577579401824-9b57c667b34b?q=80&w=1200&auto=format&fit=crop', thumb: 'https://images.unsplash.com/photo-1577579401824-9b57c667b34b?q=80&w=128&h=128&fit=crop', rules: '发挥你的色彩搭配天赋！将五彩的玻璃片，用胶水粘贴在灯罩上，组成你喜欢的图案。贴满后，交给我们的工作人员进行最后的灌浆固定就大功告成啦！', duration: 30, capacity: 14, onlineTotal: 28, sessions: ['15:45-16:15', '16:20-16:50', '16:55-17:25', '17:30-18:00']}
            ]
        },
    };

     const SCRATCH_THEMES = {
        fun: {
            bg: 'url("https://images.unsplash.com/photo-1520466487548-9c59d4a88f57?q=80&w=2574&auto=format&fit=crop")',
            positions: [{top: '15%', left: '5%'}, {top: '35%', left: '50%'}, {top: '60%', left: '15%'}, {top: '75%', left: '45%'}]
        },
        win: {
            bg: 'url("https://images.unsplash.com/photo-1579952516518-6c85a2134cbe?q=80&w=2574&auto=format&fit=crop")',
            positions: [{top: '25%', left: '15%'}, {top: '55%', left: '55%'}]
        },
        diy: {
            bg: 'url("https://images.unsplash.com/photo-1541251323365-2947715f1647?q=80&w=2574&auto=format&fit=crop")',
            positions: [{top: '10%', left: '5%'}, {top: '30%', left: '50%'}, {top: '50%', left: '15%'}, {top: '70%', left: '55%'}, {top: '85%', left: '25%'}]
        }
    };

    class H5App {
        constructor(rootId) {
            this.root = document.getElementById(rootId);
            this.appTemplate = document.getElementById('app-template');
            this.root.innerHTML = this.appTemplate.innerHTML;
            
            this.modal = document.getElementById('customModal');
            this.exploreModal = document.getElementById('exploreModal');
            this.verificationModal = document.getElementById('verificationModal');

            this.state = {
                currentUser: null,
                currentPage: 'splashPage',
                currentScratchType: null,
                registrationData: null,
                tournamentRegistrationData: { mens: [], womens: [], mixed: [] },
                craftsBookingData: [], 
                // SIMULATED BACKEND DATA for craft bookings
                allCraftsBookings: [], 
            };
            
            this.bookingToVerify = null;

            this.init();
        }

        getEl(dataId) {
            return document.querySelector(`[data-id="${dataId}"]`);
        }
        getAllEl(selector) {
            return document.querySelectorAll(selector);
        }

        init() {
            this.loadState();
            this.simulateInitialBookings(); // Simulate other users booking
            this.attachEventListeners();
            
            if (this.state.currentUser) {
                this.showPage('mapPage');
            } else {
                this.showPage('splashPage');
            }
        }
        
        // Simulate other people having booked some slots already
        simulateInitialBookings() {
            if (this.state.allCraftsBookings.length === 0) { // Only run once
                this.state.allCraftsBookings.push({id: 'diy-1', session: '15:45-16:25'});
                this.state.allCraftsBookings.push({id: 'diy-1', session: '15:45-16:25'});
                this.state.allCraftsBookings.push({id: 'diy-3', session: '16:20-16:50'});
                this.state.allCraftsBookings.push({id: 'diy-3', session: '16:20-16:50'});
                this.state.allCraftsBookings.push({id: 'diy-5', session: '17:30-18:00'});
                this.state.allCraftsBookings.push({id: 'diy-4', session: '16:20-16:50'}); // Not making it full anymore
                this.saveState();
            }
        }

        attachEventListeners() {
            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                const action = target.dataset.action;
                if (typeof this[action] === 'function') {
                    this[action](target, e);
                }
            });
            
             document.body.addEventListener('click', (e) => {
                const radio = e.target.closest('.craft-session-radio');
                if (radio) {
                    this.handleCraftsSelection(radio);
                }
            }, true);


            this.getAllEl('.badminton-reg-page form').forEach(form => {
                form.addEventListener('submit', (e) => this.handleBadmintonRegistration(e));
            });

            this.getAllEl('input[name="transport"]').forEach(radio => {
                radio.addEventListener('change', (e) => this.updateTransportInfo(e.target.value));
            });
        }
        
        showPage(target) {
            const pageId = typeof target === 'string' ? target : target.dataset.page;
            if(!pageId) return;

            this.state.currentPage = pageId;
            this.getAllEl('.page').forEach(p => p.style.display = 'none');
            const targetPage = this.root.querySelector(`#${pageId}`);
            
            if (targetPage) {
                targetPage.style.display = 'flex';
            }
            this.root.parentElement.scrollTo(0, 0);

            // Page-specific logic
            if (pageId === 'registrationPage' && this.state.currentUser) { this.populateRegistrationForm(); }
            if (pageId === 'badmintonIntroPage') { this.updateBadmintonCounts(); }
            if (pageId === 'craftsBookingPage') { this.populateCraftsBookingPage(); }
        }
        
        saveState() {
            localStorage.setItem('lillyFamilyDayState', JSON.stringify(this.state));
        }

        loadState() {
            const savedState = localStorage.getItem('lillyFamilyDayState');
            if (savedState) {
                const loaded = JSON.parse(savedState);
                this.state = { ...this.state, ...loaded };
            }
        }

        verifyEmployee() {
            const id = this.getEl('employeeIdInput').value.trim();
            const name = this.getEl('employeeNameInput').value.trim();
            const phone = this.getEl('employeePhoneInput').value.trim();
            const errorEl = this.getEl('verificationError');

            if (/^1[3-9]\d{9}$/.test(phone) && id && name) {
                errorEl.textContent = '';
                this.state.currentUser = { id, name, phone };
                this.saveState();
                this.showPage('mapPage');
            } else {
                 errorEl.textContent = '请检查输入信息是否完整或手机号格式是否正确。';
            }
        }
        
        populateRegistrationForm() {
            if (!this.state.currentUser) return;
            this.getEl('regEmployeeId').textContent = this.state.currentUser.id;
            this.getEl('regEmployeeName').textContent = this.state.currentUser.name;
            this.getEl('regEmployeePhone').textContent = this.state.currentUser.phone;
            this.getEl('familyFormsContainer').innerHTML = '';
        }

        submitRegistration() {
            const familyMembers = [];
            this.getAllEl('.family-member-form').forEach(form => {
                const name = form.querySelector('input[name="familyName"]').value.trim();
                const relation = form.querySelector('select[name="familyRelation"]').value;
                if (name && relation) {
                    familyMembers.push({ name, relation });
                }
            });

            const dining = this.root.querySelector('input[name="dining"]:checked').value;
            const transport = this.root.querySelector('input[name="transport"]:checked').value;

            this.state.registrationData = {
                employee: this.state.currentUser,
                family: familyMembers,
                dining,
                transport
            };
            this.saveState();
            this.updateSuccessPage();
            this.showPage('successPage');
        }

        updateSuccessPage() {
            if (!this.state.registrationData || !this.state.currentUser) return;
            
            const { employee } = this.state.registrationData;
            const qrData = encodeURIComponent(JSON.stringify(this.state.registrationData));
            
            this.getEl('qrCode').src = `https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${qrData}`;
            this.getEl('successName').textContent = employee.name;
            this.getEl('successId').textContent = `工号: ${employee.id}`;
            
            this.updateMyBookingsPage();
        }

        showMyBookings() {
            if (this.state.registrationData) {
                this.updateSuccessPage();
                this.showPage('successPage');
            } else {
                this.showModal('提示', '您还没有报名家庭日活动，请先报名。');
            }
        }
        
        updateMyBookingsPage() {
            const container = this.getEl('allMyBookings');
            let bookingsHtml = `<div class="bg-white rounded-xl shadow-sm p-4"><h4 class="font-bold mb-2 text-gray-800">我的家庭日凭证</h4>`;
            if (this.state.registrationData) {
                const { family, dining, transport } = this.state.registrationData;
                const familyText = family.length > 0 ? `<strong>同行家属 (${family.length}位):</strong> ${family.map(f => `${f.name}(${f.relation})`).join(', ')}` : '<strong>同行家属:</strong> 无';
                bookingsHtml += `
                    <p class="text-sm"><strong>用餐批次:</strong> ${dining}</p>
                    <p class="text-sm"><strong>出行方式:</strong> ${transport}</p>
                    <p class="text-sm">${familyText}</p>
                </div>`;
            }

            if (this.state.craftsBookingData && this.state.craftsBookingData.length > 0) {
                bookingsHtml += `<div class="bg-white rounded-xl shadow-sm p-4 mt-4"><h4 class="font-bold mb-2 text-gray-800">我的手作预约</h4>`;
                this.state.craftsBookingData.forEach((booking, index) => {
                     bookingsHtml += `
                        <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                            <p class="text-sm"><strong>${booking.title}:</strong> ${booking.session}</p>
                            <button data-action="showVerificationModal" data-booking-type="craft" data-booking-index="${index}" ${booking.verified ? 'disabled' : ''} 
                                    class="text-sm font-semibold py-1 px-3 rounded-full ${booking.verified ? 'bg-gray-200 text-gray-500' : 'bg-green-100 text-green-700 hover:bg-green-200'}">
                                ${booking.verified ? '已核销' : '现场核销'}
                            </button>
                        </div>
                     `;
                });
                 bookingsHtml += `</div>`;
            }

            const { mens, womens, mixed } = this.state.tournamentRegistrationData;
            const hasTournamentReg = mens.length > 0 || womens.length > 0 || mixed.length > 0;
            if(hasTournamentReg){
                 bookingsHtml += `<div class="bg-white rounded-xl shadow-sm p-4 mt-4"><h4 class="font-bold mb-2 text-gray-800">我的赛事报名</h4>`;
                 if (mens.length > 0) {
                    mens.forEach((p, index) => {
                        bookingsHtml += `<div class="flex justify-between items-center py-2 border-b last:border-b-0">
                                         <p class="text-sm"><strong>男单:</strong> ${p.name1}</p>
                                         <button data-action="showVerificationModal" data-booking-type="tournament" data-booking-subtype="mens" data-booking-index="${index}" ${p.verified ? 'disabled' : ''} class="text-sm font-semibold py-1 px-3 rounded-full ${p.verified ? 'bg-gray-200 text-gray-500' : 'bg-green-100 text-green-700 hover:bg-green-200'}">${p.verified ? '已核销' : '现场核销'}</button>
                                     </div>`;
                    });
                 }
                 if (womens.length > 0) {
                     womens.forEach((p, index) => {
                        bookingsHtml += `<div class="flex justify-between items-center py-2 border-b last:border-b-0">
                                         <p class="text-sm"><strong>女单:</strong> ${p.name1}</p>
                                         <button data-action="showVerificationModal" data-booking-type="tournament" data-booking-subtype="womens" data-booking-index="${index}" ${p.verified ? 'disabled' : ''} class="text-sm font-semibold py-1 px-3 rounded-full ${p.verified ? 'bg-gray-200 text-gray-500' : 'bg-green-100 text-green-700 hover:bg-green-200'}">${p.verified ? '已核销' : '现场核销'}</button>
                                     </div>`;
                    });
                 }
                 if (mixed.length > 0) {
                     mixed.forEach((p, index) => {
                        bookingsHtml += `<div class="flex justify-between items-center py-2 border-b last:border-b-0">
                                         <p class="text-sm"><strong>混双:</strong> ${p.name1}/${p.name2}</p>
                                         <button data-action="showVerificationModal" data-booking-type="tournament" data-booking-subtype="mixed" data-booking-index="${index}" ${p.verified ? 'disabled' : ''} class="text-sm font-semibold py-1 px-3 rounded-full ${p.verified ? 'bg-gray-200 text-gray-500' : 'bg-green-100 text-green-700 hover:bg-green-200'}">${p.verified ? '已核销' : '现场核销'}</button>
                                     </div>`;
                    });
                 }
                 bookingsHtml += `</div>`;
            }
            container.innerHTML = bookingsHtml;
        }


        addFamilyMemberForm() {
            const container = this.getEl('familyFormsContainer');
            const formHtml = `
                <div class="family-member-form flex gap-2 items-center border-b pb-3">
                    <input type="text" name="familyName" placeholder="家属姓名" class="w-full px-3 py-2 border rounded-md text-sm" required>
                    <select name="familyRelation" class="w-full px-3 py-2 border rounded-md bg-white text-sm" required>
                        <option value="" disabled selected>关系</option>
                        <option>配偶</option><option>子女</option><option>父母</option><option>其他</option>
                    </select>
                    <button data-action="removeFamilyMember" class="p-2 bg-red-100 text-red-600 rounded-full hover:bg-red-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', formHtml);
        }

        removeFamilyMember(target) {
            target.closest('.family-member-form').remove();
        }

        updateTransportInfo(transportValue) {
            const detailsEl = this.getEl('transportDetails');
            if (transportValue === '公司大巴') {
                detailsEl.style.display = 'block';
            } else {
                detailsEl.style.display = 'none';
            }
        }
        
        showModal(title, text, imgSrc = null) {
            this.modal.querySelector('[data-id="modalTitle"]').textContent = title;
            this.modal.querySelector('[data-id="modalText"]').textContent = text;
            const imgContainer = this.modal.querySelector('.modal-image-container');
            const imgEl = this.modal.querySelector('[data-id="modalImage"]');
            
            if (imgSrc) {
                imgEl.src = imgSrc;
                imgContainer.style.display = 'block';
            } else {
                imgContainer.style.display = 'none';
            }
            
            this.modal.classList.add('visible');
            this.modal.querySelector('[data-id="modalCloseBtn"]').onclick = () => this.hideModal();
        }

        hideModal() {
            this.modal.classList.remove('visible');
        }

        showHighlight(target) {
            const highlightKey = target.dataset.highlight;
            const data = HIGHLIGHT_DATA[highlightKey];
            if (data) {
                this.showModal(data.title, data.text, data.img);
            }
        }
        
        showPhotoAlbum() {
            this.showModal('敬请期待', '“精彩瞬间”云相册功能将在活动当日上线，为您记录每一个欢乐时刻！');
        }

        openExploreModal() {
            this.exploreModal.classList.add('visible');
        }
        closeExploreModal() {
            this.exploreModal.classList.remove('visible');
        }

        showScratchPage(target) {
            const type = target.dataset.type;
            const data = ACTIVITY_DATA[type];
            const theme = SCRATCH_THEMES[type];

            this.state.currentScratchType = type;
            this.getEl('scratchTitle').textContent = data.title;
            const scratchContent = this.getEl('scratchContent');
            
            scratchContent.style.backgroundImage = theme.bg;
            scratchContent.style.backgroundSize = 'cover';
            scratchContent.style.backgroundPosition = 'center';
            scratchContent.style.minHeight = '500px';
            scratchContent.style.position = 'relative';
            scratchContent.classList.remove('p-4', 'bg-gray-50');

            const container = this.getEl('activityListContainer');
            container.className = 'w-full h-full'; // Reset classes
            container.innerHTML = data.items.map((item, index) => {
                const pos = theme.positions[index % theme.positions.length];
                return `
                    <div data-action="showItemDetail" data-item-id="${item.id}" data-type="${type}" class="themed-activity-card" style="top: ${pos.top}; left: ${pos.left};">
                        <img src="${item.thumb}" alt="${item.title}">
                        <div>
                            <h4>${item.title}</h4>
                            <p>${item.subtitle}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            this.closeExploreModal();
            this.showPage('scratchPage');
            this.initScratchCard();
        }
        
        closeScratchPage() {
            this.openExploreModal();
        }

        initScratchCard() {
            const container = this.getEl('scratchContainer');
            const canvas = this.getEl('scratchCanvas');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
        
            const getBrushPos = (x, y) => {
                const rect = canvas.getBoundingClientRect();
                return { x: x - rect.left, y: y - rect.top };
            }
        
            const draw = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = e.touches ? getBrushPos(e.touches[0].clientX, e.touches[0].clientY) : getBrushPos(e.clientX, e.clientY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            }
        
            const start = (e) => {
                isDrawing = true;
                const pos = e.touches ? getBrushPos(e.touches[0].clientX, e.touches[0].clientY) : getBrushPos(e.clientX, e.clientY);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            }
        
            const finish = () => { isDrawing = false; }
            
             const checkClickThrough = (e) => {
                const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                
                canvas.style.pointerEvents = 'none';
                const underlyingElement = document.elementFromPoint(clientX, clientY);
                canvas.style.pointerEvents = 'auto'; 
                
                if (underlyingElement && underlyingElement.closest('[data-action]')) {
                   underlyingElement.closest('[data-action]').click();
                }
            }

            const resizeCanvas = () => {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                canvas.style.display = 'block';
                canvas.style.opacity = '1';
                canvas.style.pointerEvents = 'auto';
                ctx.fillStyle = '#ddd';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = Math.max(canvas.width, canvas.height) * 0.1;
                ctx.lineCap = 'round';
            }
            resizeCanvas();

            // Simplified event listeners
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', finish);
            canvas.addEventListener('click', checkClickThrough);

            canvas.addEventListener('touchstart', start, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', (e) => {
                finish();
                checkClickThrough(e);
            });
        }
        
        showItemDetail(target) {
            const itemId = target.dataset.itemId;
            const type = target.dataset.type;
            const item = ACTIVITY_DATA[type].items.find(i => i.id === itemId);

            if (item) {
                this.getEl('itemDetailImage').src = item.img;
                this.getEl('itemDetailTitle').textContent = item.title;
                this.getEl('itemDetailDescription').textContent = item.desc;
                this.getEl('itemDetailRules').textContent = item.rules;
                this.getEl('itemDetailBackButton').dataset.type = type;
                this.showPage('itemDetailPage');
            }
        }
        
        returnToScratchPage() {
            this.showPage('scratchPage');
        }

        handleBadmintonRegistration(event) {
             event.preventDefault();
             const form = event.target;
             const type = form.dataset.type;
             const formData = new FormData(form);
             const data = Object.fromEntries(formData.entries());
             data.verified = false; // Add verification status

             const isAlreadyRegistered = this.state.tournamentRegistrationData[type].some(p => p.name1 === data.name1);
             if(isAlreadyRegistered){
                this.showModal('重复报名', '您已经报过此项目了，无需重复报名。');
                return;
             }

             if(type === 'mixed' && data.gender1 === data.gender2){
                 this.showModal('报名提示', '混合双打项目，建议选择不同性别的搭档哦。');
             }

             this.state.tournamentRegistrationData[type].push(data);
             this.saveState();
             
             const successInfoEl = this.getEl('b-success-info');
             if(type === 'mixed'){
                 successInfoEl.innerHTML = `<p><strong>项目:</strong> 混合双打</p><p><strong>队员:</strong> ${data.name1} / ${data.name2}</p>`;
             } else {
                 successInfoEl.innerHTML = `<p><strong>项目:</strong> ${type === 'mens' ? '男子单打' : '女子单打'}</p><p><strong>选手:</strong> ${data.name1}</p>`;
             }
             this.showPage('badmintonSuccessPage');
        }

        updateBadmintonCounts() {
            const limits = { mens: 16, womens: 16, mixed: 16 };
            for(const type in limits){
                const count = this.state.tournamentRegistrationData[type].length;
                const remain = limits[type] - count;
                this.getEl(`${type}_count`).textContent = count;
                this.getEl(`${type}_remain`).textContent = remain > 0 ? remain : 0;
            }
        }
        
        showBadmintonRegPage(target) {
             if (!this.state.registrationData) {
                this.showModal('报名限制', '请您先完成家庭日活动报名，才能报名羽毛球大赛哦！');
                return;
            }
            this.showPage(target.dataset.page);
        }

        // --- CRAFTS BOOKING LOGIC ---
        populateCraftsBookingPage() {
            const container = this.getEl('craftsListContainer');
            const items = ACTIVITY_DATA.diy.items;
            
            items.forEach(item => {
                const slotsPerSession = Math.floor(item.onlineTotal / item.sessions.length);
                let remainder = item.onlineTotal % item.sessions.length;
                item.sessionCapacity = item.sessions.map(() => {
                    let capacity = slotsPerSession;
                    if (remainder > 0) {
                        capacity++;
                        remainder--;
                    }
                    return capacity;
                });
            });

            container.innerHTML = items.map(item => {
                let sessionsHtml = item.sessions.map((session, index) => {
                    const isChecked = this.state.craftsBookingData.some(b => b.id === item.id && b.session === session);
                    const bookedCount = this.state.allCraftsBookings.filter(b => b.id === item.id && b.session === session).length;
                    const capacity = item.sessionCapacity[index];
                    const remaining = capacity - bookedCount;

                    return `
                        <label class="flex items-center justify-center text-center p-2 border rounded-lg has-[:checked]:bg-green-50 has-[:checked]:border-green-600 has-[:checked]:text-green-800 has-[:checked]:font-semibold cursor-pointer transition-all">
                            <input type="radio" name="session_${item.id}" value="${session}" ${isChecked ? 'checked' : ''} ${remaining <= 0 ? 'disabled' : ''} class="craft-session-radio hidden" data-id="${item.id}" data-category="${item.category}" data-title="${item.title}">
                             <span class="text-sm">${session} <span class="text-xs ${remaining > 0 ? 'text-gray-500' : 'text-red-500'}">(余${remaining})</span></span>
                        </label>
                    `;
                }).join('');

                return `
                    <div class="event-card" data-category="${item.category}">
                       <div class="event-card-header">
                            <h4 class="font-bold font-ringside text-lg">${item.title}</h4>
                            <div class="flex items-center justify-between text-sm text-gray-500 mt-1">
                                <span>单场时长: ${item.duration}分钟</span>
                                <span>单场接待: ${item.capacity}组家庭</span>
                                <span class="text-xs font-semibold ${item.category === 'A' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'} px-2 py-1 rounded-full">${item.category === 'A' ? '老师指导' : '自由体验'}</span>
                            </div>
                       </div>
                        <div class="event-card-body">
                           <div class="session-grid">${sessionsHtml}</div>
                        </div>
                    </div>
                `;
            }).join('');
            this.handleCraftsSelection();
        }
        
        handleCraftsSelection(clickedRadio = null) {
            if (clickedRadio) {
                const booking = {
                    id: clickedRadio.dataset.id,
                    title: clickedRadio.dataset.title,
                    session: clickedRadio.value,
                    category: clickedRadio.dataset.category,
                    verified: false // Add verification status
                };
                const existingIndex = this.state.craftsBookingData.findIndex(b => b.id === booking.id && b.session === booking.session);

                if (existingIndex > -1) { // It was a deselection
                    this.state.craftsBookingData.splice(existingIndex, 1);
                } else { // It was a selection
                    this.state.craftsBookingData.push(booking);
                }
                
                this.getAllEl('.craft-session-radio').forEach(radio => {
                    radio.checked = this.state.craftsBookingData.some(b => b.id === radio.dataset.id && b.session === radio.value);
                });
            }

            // Apply rules
            const allRadios = this.getAllEl('.craft-session-radio');
            const selectedCount = this.state.craftsBookingData.length;
            const selectedACount = this.state.craftsBookingData.filter(b => b.category === 'A').length;

            allRadios.forEach(radio => {
                const isChecked = radio.checked;
                const isA = radio.dataset.category === 'A';
                 const remainingText = radio.nextElementSibling.querySelector('span').textContent;
                const isFull = remainingText.includes('(余0)');

                let shouldDisable = false;
                if (!isChecked) {
                    if (selectedCount >= 2) {
                        shouldDisable = true;
                    } else if (selectedACount >= 1 && isA) {
                        shouldDisable = true;
                    }
                }
                
                if (isFull) shouldDisable = true;

                radio.disabled = shouldDisable;
                radio.closest('label').classList.toggle('opacity-50', shouldDisable && !isFull);
                radio.closest('label').classList.toggle('cursor-not-allowed', shouldDisable);
                radio.closest('label').classList.toggle('!bg-gray-100', shouldDisable && !isFull);
                radio.closest('label').classList.toggle('!border-gray-200', shouldDisable && !isFull);
            });
        }
        
        submitCraftsBooking() {
            if (!this.state.registrationData) {
                this.showModal('报名限制', '请您先完成家庭日主活动报名，才能预约手作工坊哦！');
                return;
            }

            this.state.craftsBookingData.forEach(booking => {
                if (!this.state.allCraftsBookings.some(b => b.user === this.state.currentUser.id && b.id === booking.id)) {
                     this.state.allCraftsBookings.push({...booking, user: this.state.currentUser.id });
                }
            });
            this.saveState();

            const successInfoEl = this.getEl('c-success-info');
            if(this.state.craftsBookingData.length > 0){
                successInfoEl.innerHTML = this.state.craftsBookingData.map(b => `<p><strong>${b.title}:</strong> ${b.session}</p>`).join('');
            } else {
                 successInfoEl.innerHTML = `<p>您本次未预约任何项目。</p>`;
            }
            this.showPage('craftsSuccessPage');
        }

        // --- VERIFICATION LOGIC ---
        showVerificationModal(target) {
            const type = target.dataset.bookingType;
            const subtype = target.dataset.bookingSubtype;
            const index = parseInt(target.dataset.bookingIndex, 10);
            this.bookingToVerify = { type, subtype, index };

            let itemText = '';
            if (type === 'craft') {
                itemText = `【${this.state.craftsBookingData[index].title}】`;
            } else if (type === 'tournament') {
                const booking = this.state.tournamentRegistrationData[subtype][index];
                itemText = `【${booking.name1} - ${subtype}】`;
            }
            
            this.verificationModal.querySelector('[data-id="verificationModalText"]').textContent = `确认核销 ${itemText} 吗？此操作不可撤销。`;
            this.verificationModal.classList.add('visible');
        }

        closeVerificationModal() {
            this.verificationModal.classList.remove('visible');
            this.bookingToVerify = null;
        }

        confirmVerification() {
            if (!this.bookingToVerify) return;
            const { type, subtype, index } = this.bookingToVerify;
            if (type === 'craft') {
                this.state.craftsBookingData[index].verified = true;
            } else if (type === 'tournament') {
                this.state.tournamentRegistrationData[subtype][index].verified = true;
            }
            this.saveState();
            this.updateMyBookingsPage();
            this.closeVerificationModal();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new H5App('app-container');
    });
</script>
</body>
</html>

